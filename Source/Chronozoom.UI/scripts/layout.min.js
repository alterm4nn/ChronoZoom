var CZ;(function(n){(function(t){function e(t){t.left=n.Dates.getCoordinateFromDecimalYear(t.start);t.right=n.Dates.getCoordinateFromDecimalYear(t.end);t.endDate=t.end;t.exhibits instanceof Array&&t.exhibits.forEach(function(t){t.x=n.Dates.getCoordinateFromDecimalYear(t.time);t.contentItems.forEach(function(t){n.Extensions.activateExtension(t.mediaType)})});t.timelines instanceof Array&&t.timelines.forEach(function(n){n.ParentTimeline=t;e(n)});g(t);t.Height?t.Height/=100:t.AspectRatio||t.Height||(t.Height=n.Layout.timelineHeightRate)}function g(n){n.AspectRatio=n.aspectRatio||10}function o(t,i,u){var l=n.Settings.timelineHeaderSize+2*n.Settings.timelineHeaderMargin,h=t.right-t.left,e,s;t.width=h;t.heightEps=i*n.Settings.timelineContentMargin;t.AspectRatio&&!t.height&&(t.height=h/t.AspectRatio);t.timelines instanceof Array&&t.timelines.forEach(function(i){i.AspectRatio?i.height=(i.right-i.left)/i.AspectRatio:t.height&&i.Height&&(i.height=Math.min(t.height*i.Height,(i.right-i.left)*n.Settings.timelineMinAspect),i.offsetY!==null&&i.Height&&(i.height=t.height*i.Height));o(i,h,u)});t.height||(e=undefined,t.timelines instanceof Array&&t.timelines.forEach(function(n){if(n.Height&&!n.AspectRatio){var t=n.height/n.Height;(!e||e<t)&&(e=t)}}),e&&(t.timelines instanceof Array&&t.timelines.forEach(function(n){if(n.Height&&!n.AspectRatio){var t=e*n.Height/n.height;t>1&&(n.realY*=t,c(n,t,u))}}),t.height=e));s=a(t);t.realY=0;var v=nt(t,null,l),y=t.Height&t.offsetY?!0:!1,f=r(t,s,y,t.height,l,s);if(t.height){if(t.exhibits instanceof Array&&t.exhibits.length>0&&v.max-v.min<t.height)while(f.max-f.min>t.height&&s>h/20)s/=1.5,f=r(t,s,y,t.height,l);f.max-f.min>t.height&&(t.height=f.max-f.min)}else{var p=f.min,w=f.max,b=1/n.Settings.timelineMinAspect,k=h/b,d=Math.max(k,w-p);t.height=d}t.realHeight=t.Height&t.offsetY?t.height:t.height+2*t.heightEps;t.exhibits instanceof Array&&t.exhibits.forEach(function(n){n.realY-=f.min});t.timelines instanceof Array&&t.timelines.forEach(function(n){n.realY-=f.min})}function s(n,t,i){n.forEach(function(n){var s=[],e,r,f,o,h,u;if(t.forEach(function(t){i(n,t)&&s.push({top:t.realY+t.realHeight,bottom:t.realY})}),e=0,s.length>0){for(r=[],s.forEach(function(n){r.push({type:"bottom",value:n.bottom});r.push({type:"top",value:n.top})}),r.push({type:"bottom",value:0}),r.push({type:"top",value:0}),r.sort(function(n,t){return n.value-t.value}),f=[],o=0,u=0;u<r.length-1;u++)r[u].type=="top"?o++:o--,o==0&&r[u+1].type=="bottom"&&f.push({bottom:r[u].value,top:r[u+1].value});for(h=!1,u=0;u<f.length;u++)if(f[u].top-f[u].bottom>n.realHeight){e=f[u].bottom;h=!0;break}h||(e=r[r.length-1].value)}n.realY=e;t.push(n)})}function h(n,t,i,r,u,f,e,o){for(var y=!1,l,a,h=0,w,b,p,v,c;!y;){for(a=[],a=a.concat(r),s(t,a,function(n,t){return n.left<t.right}),s(i,a,function(n,t){return!(n.left>=t.right||t.left>=n.right)}),r.length&&(a=a.slice(r.length)),l=f!=undefined?f:Number.MIN_VALUE,a.forEach(function(n){n.realY+n.realHeight>l&&(l=n.realY+n.realHeight)}),u||(l=l/(1-e)),r.length&&(v=r[0].Height==undefined?r[0].realY/r[0].offsetY*100+r[0].realHeight/2:r[0].realY/r[0].offsetY*100,v>l&&(l=v)),y=!0;h<n.length&&y==!0;h++)w=[],a.forEach(function(t){n[h].left>=t.right||t.left>=n[h].right||w.push({top:t.realY+t.realHeight,bottom:t.realY})}),n[h].Height===undefined&&(l-=o),n[h].realY=l*n[h].offsetY/100,n[h].offsetY!==null&&n[h].Height&&(n[h].height=l*n[h].Height,n[h].realHeight=l*n[h].Height),n[h].Height===undefined&&(l+=o),b=n[h].realY,p=Number.MIN_VALUE,w.forEach(function(t){t.top<=n[h].realY||n[h].realY+n[h].realHeight<=t.bottom||(y=!1,t.top>p&&(p=t.top))}),y===!1&&(l+=n[h].Height==undefined?(p-b+o)*(1.001/(Math.max(n[h].offsetY,100-n[h].offsetY)/100)):(p-b)*(1.001/(Math.max(n[h].offsetY,100-n[h].offsetY-n[h].Height*100)/100)),r.forEach(function(n){n.offsetY!==null&&n.Height?(n.realY=l*n.offsetY/100,n.height=l*n.Height,n.realHeight=n.height):n.realY=l*n.offsetY/100-o/2})),n[h].offsetY!==null&&n[h].Height?(n[h].realY=l*n[h].offsetY/100,n[h].height=l*n[h].Height,n[h].realHeight=l*n[h].Height):n[h].realY=l*n[h].offsetY/100-o/2,r.push(n[h]);for(c=0;c<r.length;c++)r[c].realY<0&&(r[c].realY=0),r[c].realY+r[c].realHeight>l&&(r[c].realY=l-r[c].realHeight)}if(r.length)for(l=Number.MIN_VALUE,c=0;c<r.length;c++)r[c].Height===undefined?(v=r[c].offsetY===0?0:(r[c].realY+r[c].realHeight/2)/r[c].offsetY*100,r[c].realY+r[c].realHeight>v&&(v=r[c].realY+r[c].realHeight)):v=r[c].offsetY===0?0:r[c].realY/r[c].offsetY*100,l<v&&(l=v);for(c=0;c<a.length;c++)r.push(a[c]);return l}function r(n,t,i,r,u){var o=[],l=[],s=[],c=[],a,f,e;for(n.timelines instanceof Array&&n.timelines.forEach(function(n){n.offsetY!=null?s.push(n):n.Sequence?o.push(n):l.push(n)}),n.exhibits instanceof Array&&n.exhibits.forEach(function(i){i.size=t;i.left=i.x-i.size/2;i.right=i.x+i.size/2;i.realHeight=t;i.left<n.left?(i.left=n.left,i.right=i.left+i.size,i.isDeposed=!0):i.right>n.right&&(i.right=n.right,i.left=n.right-i.size,i.isDeposed=!0);i.offsetY!=null?s.push(i):i.Sequence?o.push(i):l.push(i)}),o.sort(function(n,t){return n.Sequence-t.Sequence}),a=h(s,o,l,c,i,r,u,t),f=Number.MAX_VALUE,e=0;e<c.length;e++)c[e].realY<f&&(f=c[e].realY);return s.length!=0&&(f=0),{min:f,max:a}}function nt(n,t,i){var r=[],o=[],s=[],f,e,u;for(n.timelines instanceof Array&&(n.timelines.forEach(function(n){n.offsetY!=null?s.push(n):o.push(n)}),h(s,[],o,r,t,n.height,i)),f=Number.MAX_VALUE,e=Number.MIN_VALUE,u=0;u<r.length;u++)r[u].realY<f&&(f=r[u].realY),r[u].realY+r[u].realHeight>e&&(e=r[u].realY+r[u].realHeight);return r.length==0&&(e=0,f=0),{max:e,min:f}}function c(n,t,i){if(t<1)throw"Only extending of content is allowed";n.height*=t;n.realHeight=n.height+2*n.heightEps;n.titleRect=u(n.height,n,i);n.timelines instanceof Array&&n.timelines.forEach(function(n){n.realY*=t;n.AspectRatio||c(n,t,i)});n.exhibits instanceof Array&&n.exhibits.forEach(function(n){n.realY*=t})}function l(t,i){t.y=t.offsetY!==null&&t.Height?t.realY:t.realY+t.heightEps;t.exhibits instanceof Array&&t.exhibits.forEach(function(n){n.y=n.realY+n.size/2+t.y});t.timelines instanceof Array&&t.timelines.forEach(function(u){if(u.offsetY!==null&&u.Height)for(var f=a(t),o=n.Settings.timelineHeaderSize+2*n.Settings.timelineHeaderMargin,e=r(u,f,!0,u.height,o);e.max-e.min>t.height&&f>t.width/20;)f/=1.5,e=r(t,f,!0,u.height,o);u.realY+=t.y;u.height=Math.max(u.height,n.Settings.timelineMinAspect/4*(u.right-u.left));u.height=Math.min(u.height,(u.right-u.left)*3/n.Settings.timelineMinAspect);l(u,i)});var f=u(t.height,t,i);t.titleRect=f}function a(n){return(n.right-n.left)/20}function u(t,i,r){var o=i.right-i.left;r.font="100pt "+n.Settings.timelineHeaderFontName;var s=r.measureText(i.title),u=n.Settings.timelineHeaderSize*t,e=u*s.width/100,f=Math.min(t,o)*n.Settings.timelineHeaderMargin;return e+2*f>o&&(e=o-2*f,u=e*100/s.width),{width:e-2.1*u,height:u,marginTop:t-u-f,marginLeft:f,bboxWidth:e+2*f-2.1*u,bboxHeight:u+2*f}}function v(t,i){var u=tt(i),r=n.VCContent.addTimeline(t,"layerTimelines","t"+i.id,{isBuffered:i.timelines instanceof Array,guid:i.id,timeStart:i.left,timeEnd:i.right,top:i.y,height:i.height,header:i.title,fillStyle:"rgba(0,0,0,0.25)",titleRect:i.titleRect,strokeStyle:u,regime:i.Regime,endDate:i.endDate,FromIsCirca:i.FromIsCirca||!1,ToIsCirca:i.ToIsCirca||!1,opacity:0,backgroundUrl:i.backgroundUrl,aspectRatio:i.aspectRatio,offsetY:i.offsetY,Height:i.Height});i.exhibits instanceof Array&&i.exhibits.forEach(function(t){var i=[],u,f;if(typeof t.contentItems!="undefined")for(i=t.contentItems,u=0;u<i.length;++u)i[u].guid=i[u].id;f=n.VCContent.addInfodot(r,"layerInfodots","e"+t.id,(t.left+t.right)/2,t.y,.8*t.size/2,i,{isBuffered:!1,guid:t.id,title:t.title,offsetY:t.offsetY,date:t.time,isCirca:t.IsCirca,opacity:1})});i.timelines instanceof Array&&i.timelines.forEach(function(n){v(r,n)})}function tt(n){return n.Regime=="Cosmos"?"rgba(152, 108, 157, 1.0)":n.Regime=="Earth"?"rgba(81, 127, 149, 1.0)":n.Regime=="Life"?"rgba(73, 150, 73, 1.0)":n.Regime=="Pre-history"?"rgba(237, 145, 50, 1.0)":n.Regime=="Humanity"?"rgba(212, 92, 70, 1.0)":null}function it(n,t){n.beginEdit();v(n,t);n.endEdit(!0)}function y(n,t){if(t){e(t);var i=document.createElement("canvas").getContext("2d");o(t,0,i);l(t,i);it(n,t)}}function p(t,i){try{t.AspectRatio||(t.height=i.height);var r=new n.VCContent.CanvasRootElement(i.vc,undefined,"__root__",-Infinity,-Infinity,Infinity,Infinity);return y(r,t),r.children[0]}catch(u){console.log("exception in [nikita's layout]: "+u)}}function f(n,t){t&&(typeof n.y!="undefined"&&(n.y+=t,n.newY+=t),typeof n.baseline!="undefined"&&(n.baseline+=t,n.newBaseline+=t),n.children.forEach(function(n){f(n,t)}))}function w(n,t){t&&(typeof n.newY!="undefined"&&(n.newY+=t),typeof n.newBaseline!="undefined"&&(n.newBaseline+=t),n.children.forEach(function(n){w(n,t)}))}function rt(n){for(var i,o,t,s=n.height/10,u=[],r=0;r<n.children.length;r++)i=n.children[r],i.type&&(i.type==="timeline"||i.type==="infodot")&&(i.force=0,u.push(i));for(u.sort(function(n,t){return n.newY-t.newY}),r=0;r<u.length;r++)if(i=u[r],i.type&&i.type==="timeline"&&i.delta){var f=i.x,e=i.x+i.width,h=i.y+i.newHeight+s;for(o=r+1;o<u.length;o++)if(t=u[o],t.x>f&&t.x<e||t.x+t.width>f&&t.x+t.width<e||t.x+t.width>f&&t.x+t.width===0&&e===0)if(t.y<h)t.force+=i.delta,f=Math.min(f,t.x),e=Math.max(e,t.x+t.width),h=t.y+t.newHeight+i.delta+s;else break}}function i(t){var f=n.Settings.canvasElementAnimationTime,u=[],r;if(t.fadeIn==!1&&typeof t.animation=="undefined"&&(t.height=t.newHeight,t.y=t.newY,t.baseline&&(t.baseline=t.newBaseline)),t.newY==t.y||t.id.match("__header__")||u.push({property:"y",startValue:t.y,targetValue:t.newY}),t.newHeight==t.height||t.id.match("__header__")||u.push({property:"height",startValue:t.height,targetValue:t.newHeight}),t.opacity!=1&&t.fadeIn==!1&&(u.push({property:"opacity",startValue:t.opacity,targetValue:1}),f=n.Settings.canvasElementFadeInTime),(d==!1||u.length==0)&&(f=0),ut(t,f,u),t.fadeIn==!0)for(r=0;r<t.children.length;r++)t.children[r].fadeIn==!0&&i(t.children[r]);else for(r=0;r<t.children.length;r++)i(t.children[r])}function ut(r,u,f){var e=(new Date).getTime();r.animation={isAnimating:!0,duration:u,startTime:e,args:f};typeof t.animatingElements[r.id]=="undefined"&&(t.animatingElements[r.id]=r,t.animatingElements.length++);r.calculateNewFrame=function(){var o=(new Date).getTime(),e,u;for(e=r.animation.duration>0?Math.min(1,(o-r.animation.startTime)/r.animation.duration):1,e=n.ViewportAnimation.animationEase(e),u=0;u<f.length;u++)typeof r[f[u].property]!="undefined"&&(r[r.animation.args[u].property]=r.animation.args[u].startValue+e*(r.animation.args[u].targetValue-r.animation.args[u].startValue));if(e==1){for(r.animation.isAnimating=!1,r.animation.args=[],delete t.animatingElements[r.id],t.animatingElements.length--,r.fadeIn==!1&&(r.fadeIn=!0),u=0;u<r.children.length;u++)typeof r.children[u].animation=="undefined"&&i(r.children[u]);return}}}function b(n){var t=n.toString().split(".");return t[0].replace(/\B(?=(\d{3})+(?!\d))/g,",")+(t[1]?"."+t[1]:"")}function k(t,i){var h,o,l,a,d,u,y,e,v,s,tt,r;if(t.id===i.guid){for(h=t.timelines instanceof Array?t.timelines:[],o=[],r=0;r<i.children.length;r++)i.children[r].type&&i.children[r].type==="timeline"&&o.push(i.children[r]);if(h.length===o.length){for(i.isBuffered=i.isBuffered||t.timelines instanceof Array,l=Number.MAX_VALUE,a=Number.MIN_VALUE,r=0;r<i.children.length;r++)i.children[r].type&&(i.children[r].type==="timeline"||i.children[r].type==="infodot")&&(i.children[r].newY<l&&(l=i.children[r].newY),i.children[r].newY+i.children[r].newHeight>a&&(a=i.children[r].newY+i.children[r].newHeight));for(i.delta=0,r=0;r<h.length;r++)k(h[r],o[r]);for(d=!1,r=0;r<o.length;r++)o[r].delta&&(d=!0);if(d){for(r=0;r<o.length;r++)o[r].delta&&(o[r].newHeight+=o[r].delta);for(rt(i),r=0;r<i.children.length;r++)i.children[r].force&&w(i.children[r],i.children[r].force);var g=Number.MAX_VALUE,c=Number.MIN_VALUE,nt="";for(r=0;r<i.children.length;r++)i.children[r].type&&(i.children[r].type==="timeline"||i.children[r].type==="infodot")&&(i.children[r].newY<g&&(g=i.children[r].newY),i.children[r].newY+i.children[r].newHeight>c&&(c=i.children[r].newY+i.children[r].newHeight,nt=i.children[r].title));for(i.delta=Math.max(0,c-g-(a-l)),i.titleObject.newY+=i.delta,i.titleObject.newBaseline+=i.delta,i.titleObject.opacity=0,i.titleObject.fadeIn=!1,delete i.titleObject.animation,c>i.titleObject.newY&&(v=nt+" EXCEEDS "+i.title+".\nbottom: "+b(c)+"\n   top: "+b(i.titleObject.newY)+"\n",console.log(v)),r=1;r<i.children.length;r++)for(u=i.children[r],y=1;y<i.children.length;y++)e=i.children[y],u.id!==e.id&&(e.x<=u.x&&e.x+e.width<=u.x||e.x>=u.x+u.width&&e.x+e.width>=u.x+u.width||e.newY<=u.newY&&e.newY+e.newHeight<=u.newY||e.newY>=u.newY+u.newHeight&&e.newY+e.newHeight>=u.newY+u.newHeight||(v=u.title+" OVERLAPS "+e.title+".\n",console.log(v)))}}else if(h.length>0&&o.length===0){for(s=p(t,i),tt=Math.min(s.width,s.newHeight)*n.Settings.timelineHeaderMargin,i.delta=Math.max(0,s.newHeight-i.newHeight),i.children.splice(0),r=0;r<s.children.length;r++)i.children.push(s.children[r]);for(i.titleObject=i.children[0],i.isBuffered=i.isBuffered||t.timelines instanceof Array,r=0;r<i.children.length;r++)f(i.children[r],i.newY)}else i.delta=0}else throw"error: Cannot merge timelines. Src and dest node ids differ.";}function ft(t,r){if((typeof n.Authoring=="undefined"||!n.Authoring.isActive)&&t&&r)if(r.id==="__root__"){t.AspectRatio=t.aspectRatio||10;var u=p(t,r);f(u,0);r.children.push(u);i(r);n.Common.vc.virtualCanvas("requestInvalidate")}else k(t,r),r.newHeight+=r.delta,i(r),n.Common.vc.virtualCanvas("requestInvalidate")}var d=!0;t.animatingElements={length:0};t.timelineHeightRate=.4;t.GenerateTitleObject=u;t.FindChildTimeline=function(n,i,r){var u=undefined,o,f,e;if(n&&n.timelines instanceof Array)for(o=n.timelines.length,f=0;f<o;f++)if(e=n.timelines[f],e.id==i){u=e;break}else if(r==!0&&(u=t.FindChildTimeline(e,i,r),u!=undefined))break;return u};t.Load=y;t.Merge=ft})(n.Layout||(n.Layout={}));var t=n.Layout})(CZ||(CZ={}));
//# sourceMappingURL=layout.min.js.map
