var CZ;(function(n){(function(t){function b(t,i,r,u){var o=2*(n.Settings.contentScaleMargin&&u?n.Settings.contentScaleMargin:0),e=r.width-o,s,f,h,c;return e<0&&(e=r.width),s=i*t.width/e,f=r.height-o,f<0&&(f=r.height),h=i*t.height/f,c={centerX:t.x+t.width/2,centerY:t.y+t.height/2,scale:Math.max(s,h)},c}function i(n,t,i,r,u,f,e){this.vc=n;this.id=i;this.layerid=t;this.x=r;this.y=u;this.newY=u;this.width=f;this.height=e;this.newHeight=e;this.children=[];this.fadeIn=!1;this.isVisible=function(n){var t=this.x+this.width,i=this.y+this.height;return Math.max(this.x,n.Left)<=Math.min(t,n.Right)&&Math.max(this.y,n.Top)<=Math.min(i,n.Bottom)};this.isInside=function(n){return n.x>=this.x&&n.x<=this.x+this.width&&n.y>=this.y&&n.y<=this.y+this.height};this.render=function(){}}function u(n,i,r,u,f,e,o,s,h,c){return t.addChild(n,new et(n.vc,i,r,u,f,e,o,s,h,c),!1)}function d(n,i,r,u,f,e,o,s,h){return t.addChild(n,new ht(n.vc,i,r,u,f,e,o,s,h),!1)}function nt(n,i,r,u,f,e,o,s,h,c){return t.addChild(n,new ot(n.vc,i,r,u,f,o,s,h,c),!1)}function a(n){n.isRendered=!1;n.onIsRenderedChanged&&n.onIsRenderedChanged();for(var t=n.children.length;--t>=0;)n.children[t].isRendered&&a(n.children[t])}function v(t){for(var i,u=t.children.length,r=0;r<u;r++)i=t.children[r],typeof n.Layout.animatingElements[i.id]!="undefined"&&(delete n.Layout.animatingElements[i.id],n.Layout.animatingElements.length--),v(i),i.onRemove&&i.onRemove(),i.parent=null;t.children=[]}function it(n,t){for(var r=n.children.length,i=0;i<r;i++)if(n.children[i].id==t)return n.children[i];throw"There is no child with id ["+t+"]";}function rt(n,r,u,f,e,o,s){this.base=i;this.base(n,r,u,f,e,o,s);this.opacity=0;this.isVisible=function(){return this.children.length!=0};this.beginEdit=function(){return this};this.endEdit=function(n){n||this.vc.invalidate()};this.isInside=function(){return!0};this.render=function(i,r,u){var e,f;if(this.vc.breadCrumbs=[],this.isVisible(r)){for(e=this.children.length,f=0;f<e;f++)t.render(this.children[f],i,r,u,1);this.vc.breadCrumbs.length>0&&(this.vc.recentBreadCrumb==undefined||this.vc.breadCrumbs[n.breadCrumbs.length-1].vcElement.id!=this.vc.recentBreadCrumb.vcElement.id)?(this.vc.recentBreadCrumb=this.vc.breadCrumbs[n.breadCrumbs.length-1],this.vc.breadCrumbsChanged()):this.vc.breadCrumbs.length==0&&this.vc.recentBreadCrumb!=undefined&&(this.vc.recentBreadCrumb=undefined,this.vc.breadCrumbsChanged())}};this.prototype=new i(n,r,u,f,e,o,s)}function ut(n){var t=Math.max(n.x,n.y),r,i;if(t<=1)return 0;for(r=t&1?1:0,i=1;i<32;i++)t=t>>>1,t&1&&(r=r>0?i+1:i);return r}function e(n,r,u,f,e,o,s){var h,c,l;this.base=i;this.base(n,r,u,f,e,o,s);this.zoomLevel=0;this.prevContent=null;this.newContent=null;this.asyncContent=null;this.lastRenderTime=0;h=this;this.changeZoomLevel=function(){return null};c=function(n){h.lastRenderTime=new Date;h.prevContent=h.content;h.content=n.content;t.addChild(h,h.content,!1);h.prevContent&&(h.prevContent.opacity||(h.prevContent.opacity=1),h.content.opacity=0);h.zoomLevel=n.zoomLevel};l=function(){h.asyncContent&&(c(h.asyncContent),h.asyncContent=null,delete this.onLoad,h.vc.requestInvalidate())};this.render=function(n,i,r,u){var s,e,a,v;if(!this.asyncContent&&(this.prevContent||(s=ut(u),this.zoomLevel!=s&&(e=this.changeZoomLevel(this.zoomLevel,s),e&&(e.content.isLoading?(this.asyncContent=e,e.content.onLoad=l):c(e)))),this.prevContent)){a=new Date;v=a.getTime()-h.lastRenderTime;h.lastRenderTime=a.getTime();var y=v/1600,o=!1,f=this.prevContent.opacity;f=Math.max(0,f-y);f!=this.prevContent.opacity&&(o=!0);f==0?(t.removeChild(this,this.prevContent.id),this.prevContent=null):this.prevContent.opacity=f;f=this.content.opacity;f=Math.min(1,f+y);o||f==this.content.opacity||(o=!0);this.content.opacity=f;o&&this.vc.requestInvalidate()}};this.onIsRenderedChanged=function(){typeof this.removeWhenInvisible!="undefined"&&this.removeWhenInvisible&&(this.isRendered||(this.asyncContent&&(this.asyncContent=null),this.prevContent&&(t.removeChild(this,this.prevContent.id),this.prevContent=null),this.newContent&&(t.removeChild(this,this.newContent.id),this.newContent.content.onLoad=null,this.newContent=null),this.content&&(t.removeChild(this,this.content.id),this.content=null),this.zoomLevel=0))};this.prototype=new i(n,r,u,f,e,o,s)}function o(n,t,r,u,f,e,o){this.base=i;this.base(n,t,r,u,f,e,o);this.render=function(){};this.prototype=new i(n,t,r,u,f,e,o)}function s(t,r,u,f,e,o,s,h){this.base=i;this.base(t,r,u,f,e,o,s);this.settings=h;this.type="rectangle";this.render=function(n,t,i,r,u){var e=i.pointVirtualToScreen(this.x,this.y),o=i.pointVirtualToScreen(this.x+this.width,this.y+this.height),s=Math.max(0,e.x),h=Math.max(0,e.y),c=Math.min(i.width,o.x),l=Math.min(i.height,o.y),v,a,y,f;s<c&&h<l&&(this.settings.fillStyle&&(v=this.settings.gradientOpacity?u*(1-this.settings.gradientOpacity):u,n.globalAlpha=v,n.fillStyle=this.settings.fillStyle,n.fillRect(s,h,c-s,l-h),this.settings.gradientOpacity&&this.settings.gradientFillStyle&&(a=n.createLinearGradient(s,l,c,h),y="rgba(0, 0, 0, 0)",a.addColorStop(0,this.settings.gradientFillStyle),a.addColorStop(1,y),n.globalAlpha=u*this.settings.gradientOpacity,n.fillStyle=a,n.fillRect(s,h,c-s,l-h))),n.globalAlpha=u,this.settings.strokeStyle&&(n.strokeStyle=this.settings.strokeStyle,n.lineWidth=this.settings.lineWidth?this.settings.isLineWidthVirtual?i.widthVirtualToScreen(this.settings.lineWidth):this.settings.lineWidth:1,f=n.lineWidth/2,this.settings.outline&&(e.x+=f,e.y+=f,h+=f,l-=f,s+=f,c-=f,o.x-=f,o.y-=f),e.x>0&&(this.settings.showFromCirca&&n.setLineDash&&n.setLineDash([6,3]),n.beginPath(),n.moveTo(e.x,h-f),n.lineTo(e.x,l+f),n.stroke(),n.setLineDash&&n.setLineDash([])),e.y>0&&(n.beginPath(),n.moveTo(s-f,e.y),n.lineTo(c+f,e.y),n.stroke()),o.x<i.width&&(this.settings.showToCirca&&n.setLineDash&&n.setLineDash([6,3]),this.settings.showInfinite&&n.setLineDash&&n.setLineDash([1,3]),n.beginPath(),n.moveTo(o.x,h-f),n.lineTo(o.x,l+f),n.stroke(),n.setLineDash&&n.setLineDash([])),o.y<i.height&&(n.beginPath(),n.moveTo(s-f,o.y),n.lineTo(c+f,o.y),n.stroke())))};this.intersects=function(n){return!(this.x+this.width<n.x||this.x>n.x+n.width||this.y+this.height<n.y||this.y>n.y+n.height)};this.contains=function(n){return n.x>this.x&&n.x+n.width<this.x+this.width&&n.y>this.y&&n.y+n.height<this.y+this.height};this.isVisibleOnScreen=function(t){return this.width/t>=n.Settings.minTimelineWidth};this.prototype=new i(t,r,u,f,e,o,s)}function ft(i,r,e,o,h,c,l,a,v){var y=this;this.base=s;this.base(i,r,e,o,h,c,l);this.guid=v.guid;this.type="timeline";this.isBuffered=v.isBuffered;this.settings=a;this.parent=undefined;this.currentlyObservedTimelineEvent=i.currentlyObservedTimelineEvent;this.settings.outline=!0;this.type="timeline";this.endDate=v.endDate;this.FromIsCirca=v.FromIsCirca||!1;this.ToIsCirca=v.ToIsCirca||!1;this.backgroundUrl=v.backgroundUrl||"";this.aspectRatio=v.aspectRatio||null;this.settings.showFromCirca=this.FromIsCirca;this.settings.showToCirca=this.ToIsCirca;this.settings.showInfinite=v.endDate==9999;var g=v.timeEnd-v.timeStart,p=v.titleRect?v.titleRect.height:n.Settings.timelineHeaderSize*v.height,k=v.titleRect&&(n.Authoring.isEnabled||n.Settings.isAuthorized)?v.titleRect.width:0,w=v.titleRect?v.titleRect.marginLeft:n.Settings.timelineHeaderMargin*v.height,b=v.titleRect?v.titleRect.marginTop:(1-n.Settings.timelineHeaderMargin)*v.height-p,d=v.top+b+p/2;this.titleObject=u(this,r,e+"__header__",n.Authoring.isEnabled?v.timeStart+w+p:v.timeStart+w,v.top+b,d,p,v.header,{fontName:n.Settings.timelineHeaderFontName,fillStyle:n.Settings.timelineHeaderFontColor,textBaseline:"middle"},k);this.title=this.titleObject.text;this.regime=v.regime;this.settings.gradientOpacity=0;this.settings.gradientFillStyle=n.Settings.timelineGradientFillStyle?n.Settings.timelineGradientFillStyle:v.gradientFillStyle||v.strokeStyle?v.strokeStyle:n.Settings.timelineBorderColor;this.reactsOnMouse=!0;this.tooltipEnabled=!0;this.tooltipIsShown=!1;y.backgroundUrl&&(y.backgroundImg=new wt(y.vc,r,e+"__background__",y.backgroundUrl,y.x,y.y,y.width,y.height),y.settings.gradientOpacity=0,y.settings.fillStyle=undefined);this.onmouseclick=function(n){return f(this,n,1)};this.onmousehover=function(){if(this.vc.currentlyHoveredTimeline!=null&&this.vc.currentlyHoveredTimeline.id!=e)try{this.vc.currentlyHoveredInfodot.id}catch(i){n.Common.stopAnimationTooltip();this.vc.currentlyHoveredTimeline.tooltipIsShown=!1}if(this.vc.currentlyHoveredTimeline=this,this.settings.strokeStyle=n.Settings.timelineHoveredBoxBorderColor,this.settings.lineWidth=n.Settings.timelineHoveredLineWidth,this.titleObject.settings.fillStyle=n.Settings.timelineHoveredHeaderFontColor,this.settings.hoverAnimationDelta=n.Settings.timelineHoverAnimation,this.vc.requestInvalidate(),this.titleObject.initialized==!1){var t=this.vc.getViewport();this.titleObject.screenFontSize=n.Settings.timelineHeaderSize*t.heightVirtualToScreen(this.height)}if(this.tooltipEnabled=this.titleObject.screenFontSize<=n.Settings.timelineTooltipMaxHeaderSize?!0:!1,n.Common.tooltipMode!="infodot"){if(n.Common.tooltipMode="timeline",this.tooltipEnabled==!1){n.Common.stopAnimationTooltip();this.tooltipIsShown=!1;return}if(this.tooltipIsShown==!1){switch(this.regime){case"Cosmos":$(".bubbleInfo").attr("id","cosmosRegimeBox");break;case"Earth":$(".bubbleInfo").attr("id","earthRegimeBox");break;case"Life":$(".bubbleInfo").attr("id","lifeRegimeBox");break;case"Pre-history":$(".bubbleInfo").attr("id","prehistoryRegimeBox");break;case"Humanity":$(".bubbleInfo").attr("id","humanityRegimeBox")}$(".bubbleInfo span").text(this.title);this.panelWidth=$(".bubbleInfo").outerWidth();this.panelHeight=$(".bubbleInfo").outerHeight();this.tooltipIsShown=!0;n.Common.animationTooltipRunning=$(".bubbleInfo").fadeIn()}}};this.onmouseunhover=function(){this.vc.currentlyHoveredTimeline!=null&&this.vc.currentlyHoveredTimeline.id==e&&(this.vc.currentlyHoveredTimeline=null,this.tooltipIsShown==!0&&n.Common.tooltipMode=="timeline"&&(n.Common.tooltipMode="default",n.Common.stopAnimationTooltip(),$(".bubbleInfo").attr("id","defaultBox"),this.tooltipIsShown=!1));this.settings.strokeStyle=v.strokeStyle?v.strokeStyle:n.Settings.timelineBorderColor;this.settings.lineWidth=n.Settings.timelineLineWidth;this.titleObject.settings.fillStyle=n.Settings.timelineHeaderFontColor;this.settings.hoverAnimationDelta=-n.Settings.timelineHoverAnimation;this.vc.requestInvalidate()};this.base_render=this.render;this.render=function(u,f,o,s,h){var c,l,p;this.titleObject.initialized=!1;this.settings.hoverAnimationDelta&&(this.settings.gradientOpacity=Math.min(1,Math.max(0,this.settings.gradientOpacity+this.settings.hoverAnimationDelta)));typeof y.backgroundImg!="undefined"&&y.backgroundImg.render(u,f,o,s,1);y.base_render(u,f,o,s,h);c=this.x+this.width-1*this.titleObject.height;l=this.titleObject.y+.15*this.titleObject.height;typeof this.tweetBtn=="undefined"&&this.titleObject.width!==0&&(this.tweetBtn=t.addImage(this,r,e+"__tweet",c,l,.7*this.titleObject.height,.7*this.titleObject.height,"/images/icon_twitter_canvas.svg"),this.tweetBtn.reactsOnMouse=!0,this.tweetBtn.onmouseclick=function(){function i(t){t.id!=="__root__"&&(n="/"+t.id+n,i(t.parent))}var t=null,n="";if(i(this.parent),n=window.location.origin+window.location.pathname+"#"+n,t=$.ajax({async:!1,timeout:5e3,type:"GET",url:"http://to.ly/api.php?json=1&longurl="+encodeURIComponent(n)+"&callback=?"}).responseText,t!==null)try{t=JSON.parse(t.slice(2,-1)).shorturl;n=t}catch(r){}window.open("http://twitter.com/share?url="+encodeURIComponent(n)+"&hashtags=chronozoom&text="+encodeURIComponent(this.parent.title+" - "))},this.tweetBtn.onmousehover=function(){this.vc.element.css("cursor","pointer");this.vc.element.attr("title","Share on Twitter")},this.tweetBtn.onmouseunhover=function(){this.vc.element.css("cursor","default");this.vc.element.attr("title","")},this.tweetBtn.onRemove=function(){this.onmousehover=undefined;this.onmouseunhover=undefined;this.onmouseclick=undefined});n.Settings.isAuthorized===!0&&typeof this.favoriteBtn=="undefined"&&this.titleObject.width!==0&&(c-=this.titleObject.height,this.favoriteBtn=t.addImage(this,r,e+"__favorite",c,l,.7*this.titleObject.height,.7*this.titleObject.height,"/images/star.svg"),this.favoriteBtn.reactsOnMouse=!0,this.favoriteBtn.onmouseclick=function(){var t=this;return n.Settings.favoriteTimelines.indexOf(this.parent.guid)!==-1?(n.Service.deleteUserFavorite(this.parent.guid).then(function(){n.Authoring.showMessageWindow('"'+t.parent.title+'" was removed from your favorite timelines.',"Timeline removed from favorites")},function(){console.log("[ERROR] /deleteUserFavorite with guid "+t.parent.guid+" failed.")}),n.Settings.favoriteTimelines.splice(n.Settings.favoriteTimelines.indexOf(this.parent.guid),1)):n.Service.putUserFavorite(this.parent.guid).then(function(){n.Settings.favoriteTimelines.push(t.parent.guid);n.Authoring.showMessageWindow('"'+t.parent.title+'" was added to your favorite timelines.',"Favorite timeline added")},function(){console.log("[ERROR] /putUserFavorite with guid + "+t.parent.guid+" failed.")}),!0},this.favoriteBtn.onmousehover=function(){this.vc.element.css("cursor","pointer");this.vc.element.attr("title","Add to or Remove from Favorites");this.parent.settings.strokeStyle="yellow"},this.favoriteBtn.onmouseunhover=function(){this.vc.element.css("cursor","default");this.vc.element.attr("title","");this.parent.settings.strokeStyle=v.strokeStyle?v.strokeStyle:n.Settings.timelineBorderColor},this.favoriteBtn.onRemove=function(){this.onmousehover=undefined;this.onmouseunhover=undefined;this.onmouseclick=undefined});n.Authoring.isEnabled===!0&&typeof this.pasteButton=="undefined"&&this.titleObject.width!==0&&(c-=this.titleObject.height,this.pasteButton=t.addImage(this,r,e+"__paste",c,l,.7*this.titleObject.height,.7*this.titleObject.height,"/images/paste.svg"),this.pasteButton.reactsOnMouse=!0,this.pasteButton.onmousehover=function(){this.vc.element.css("cursor","pointer");this.vc.element.attr("title","Paste Timeline/Exhibit");this.parent.settings.strokeStyle="yellow"},this.pasteButton.onmouseunhover=function(){this.vc.element.css("cursor","default");this.vc.element.attr("title","");this.parent.settings.strokeStyle=v.strokeStyle?v.strokeStyle:n.Settings.timelineBorderColor},this.pasteButton.onmouseclick=function(){var t=localStorage.getItem("ExportedTimeline"),i=localStorage.getItem("ExportedExhibit"),r=localStorage.getItem("ExportedSchemaVersion")==constants.schemaVersion;r&&t!=null?n.Service.importTimelines(this.parent.guid,t).then(function(t){n.Authoring.showMessageWindow(t)}):r&&i!=null?n.Service.importExhibit(this.parent.guid,i).then(function(t){n.Authoring.showMessageWindow(t)}):n.Authoring.showMessageWindow("Please copy a timeline to your ChronoZoom clip-board first.","Unable to Paste Timeline")},this.pasteButton.onRemove=function(){this.onmousehover=undefined;this.onmouseunhover=undefined;this.onmouseclick=undefined});typeof this.copyButton=="undefined"&&this.titleObject.width!==0&&(c-=this.titleObject.height,this.copyButton=t.addImage(this,r,e+"__copy",c,l,.7*this.titleObject.height,.7*this.titleObject.height,"/images/copy.svg"),this.copyButton.reactsOnMouse=!0,this.copyButton.onmousehover=function(){this.vc.element.css("cursor","pointer");this.vc.element.attr("title","Copy Timeline");this.parent.settings.strokeStyle="yellow"},this.copyButton.onmouseunhover=function(){this.vc.element.css("cursor","default");this.vc.element.attr("title","");this.parent.settings.strokeStyle=v.strokeStyle?v.strokeStyle:n.Settings.timelineBorderColor},this.copyButton.onmouseclick=function(){n.Service.exportTimelines(this.parent.guid).then(function(t){localStorage.setItem("ExportedSchemaVersion",constants.schemaVersion);localStorage.setItem("ExportedTimeline",JSON.stringify(t));localStorage.removeItem("ExportedExhibit");n.Authoring.showMessageWindow('"'+t[0].timeline.title+'" has been copied to your clip-board. You can paste this into a different timeline.')})},this.copyButton.onRemove=function(){this.onmousehover=undefined;this.onmouseunhover=undefined;this.onmouseclick=undefined});n.Authoring.isEnabled&&typeof this.editButton=="undefined"&&this.titleObject.width!==0&&(this.editButton=t.addImage(this,r,e+"__edit",this.x+this.titleObject.height*.15,this.titleObject.y,this.titleObject.height,this.titleObject.height,"/images/edit.svg"),this.editButton.reactsOnMouse=!0,this.editButton.onmouseclick=function(){return n.Common.vc.virtualCanvas("getHoveredInfodot").x==undefined&&(n.Authoring.isActive=!0,n.Authoring.mode="editTimeline",n.Authoring.selectedTimeline=this.parent),!0},this.editButton.onmousehover=function(){this.vc.element.css("cursor","pointer");this.vc.element.attr("title","Edit Timeline");this.parent.settings.strokeStyle="yellow"},this.editButton.onmouseunhover=function(){this.vc.element.css("cursor","default");this.vc.element.attr("title","");this.parent.settings.strokeStyle=v.strokeStyle?v.strokeStyle:n.Settings.timelineBorderColor},this.editButton.onRemove=function(){this.onmousehover=undefined;this.onmouseunhover=undefined;this.onmouseclick=undefined});this.settings.hoverAnimationDelta&&(this.settings.gradientOpacity==0||this.settings.gradientOpacity==1?this.settings.hoverAnimationDelta=undefined:this.vc.requestInvalidate());var a=o.pointVirtualToScreen(this.x,this.y),w={x:a.x+s.x,y:a.y+s.y},b=o.visible.centerX-n.Settings.timelineCenterOffsetAcceptableImplicity<=this.x+this.width&&o.visible.centerX+n.Settings.timelineCenterOffsetAcceptableImplicity>=this.x&&o.visible.centerY-n.Settings.timelineCenterOffsetAcceptableImplicity<=this.y+this.height&&o.visible.centerY+n.Settings.timelineCenterOffsetAcceptableImplicity>=this.y,k=a.x<n.Settings.timelineBreadCrumbBorderOffset&&w.x>o.width-n.Settings.timelineBreadCrumbBorderOffset||a.y<n.Settings.timelineBreadCrumbBorderOffset&&w.y>o.height-n.Settings.timelineBreadCrumbBorderOffset;if(k&&b){if(p=i.breadCrumbs.length,p>1&&i.breadCrumbs[p-1].vcElement.parent.id==this.parent.id)return;i.breadCrumbs.push({vcElement:this})}};this.prototype=new s(i,r,e,o,h,c,l,a)}function y(t,r,u,f,e,o,s){this.base=i;this.base(t,r,u,f-o,e-o,2*o,2*o);this.settings=s;this.isObservedNow=!1;this.type="circle";this.render=function(n,t,i,r,u){var f=this.width/2,o=this.x+f,s=this.y+f,e=i.pointVirtualToScreen(o,s),h=i.widthVirtualToScreen(f);this.settings.showCirca&&n.setLineDash&&n.setLineDash([6,3]);n.globalAlpha=u;n.beginPath();n.arc(e.x,e.y,h,0,Math.PI*2,!0);this.settings.strokeStyle&&(n.strokeStyle=this.settings.strokeStyle,n.lineWidth=this.settings.lineWidth?this.settings.isLineWidthVirtual?i.widthVirtualToScreen(this.settings.lineWidth):this.settings.lineWidth:1,n.stroke());this.settings.fillStyle&&(n.fillStyle=this.settings.fillStyle,n.fill());n.setLineDash&&n.setLineDash([])};this.isInside=function(t){var i=n.Common.sqr(t.x-f)+n.Common.sqr(t.y-this.y-this.height/2);return i<=o*o};this.prototype=new i(t,r,u,f-o/2,e-o/2,o,o)}function g(n,t,i,r,u,f){var o=$.browser,h=o.msie&&parseInt(o.version,10)>=9;if(h)t.font=u+"pt "+f,t.fillText(n,i,r);else{var s=12,c=u,e=c/s;t.scale(e,e);t.font=s+"pt "+f;t.fillText(n,i/e,r/e);t.scale(1/e,1/e)}}function et(n,t,r,u,f,e,o,s,h,c){this.base=i;this.base(n,t,r,u,f,c?c:0,o);this.text=s;this.baseline=e;this.newBaseline=e;this.settings=h;this.opacity=h.opacity||0;this.type="text";typeof this.settings.textBaseline!="undefined"&&this.settings.textBaseline==="middle"&&(this.newBaseline=this.newY+this.newHeight/2);this.initialized=!1;this.screenFontSize=0;this.render=function(n,t,i,r,u){var e=i.pointVirtualToScreen(this.x,this.newY),y=i.pointVirtualToScreen(this.x,this.newBaseline).y,f,h,k,p,o,tt,it,ut,s,w,b;if(n.globalAlpha=u,n.fillStyle=this.settings.fillStyle,f=r.y,h=1.5,this.screenFontSize!=f&&(this.screenFontSize=f),!this.initialized){if(this.settings.wrapText){for(k=this.settings.numberOfLines?this.settings.numberOfLines:1,this.settings.numberOfLines=k,f=r.y/k/h;;){n.font=f+"pt "+this.settings.fontName;var rt=this.text.split("\n"),d=0,nt=[];for(p=0;p<rt.length;p++){var a=rt[p].split(" "),c=0,l="",v,ft=n.measureText(" ").width;for(o=0;o<a.length;o++)if(v=n.measureText(a[o]),tt=c==0?c+v.width:c+v.width+ft,tt>r.x&&c>0?(nt.push(l),c=0,d+=f*h,o--,l=""):(l===""?l=a[o]:l+=" "+a[o],c=tt),a.length==1&&v.width>r.x)for(it=v.width;it>r.x;)f/=1.5,it/=1.5;nt.push(l);d+=f*h}if(d>r.y)f/=1.5;else{this.text=nt;ut=i.heightScreenToVirtual(f);this.settings.fontSizeVirtual=ut;break}}this.screenFontSize=f}else n.font=f+"pt "+this.settings.fontName,this.screenFontSize=f,this.width==0?(s=n.measureText(this.text),r.x=s.width,this.width=i.widthScreenToVirtual(s.width)):(s=n.measureText(this.text),s.width>r.x?(this.height=this.width*r.y/s.width,this.settings.textBaseline==="middle"&&(this.newY=this.newBaseline-this.newHeight/2),f=i.heightVirtualToScreen(this.height),this.screenFontSize=f):typeof this.settings.adjustWidth&&this.settings.adjustWidth&&(w=i.widthScreenToVirtual(s.width),this.settings.textAlign==="center"?this.x=this.x+(this.width-w)/2:this.settings.textAlign==="right"&&(this.x=this.x+this.width-w),this.width=w,e=i.pointVirtualToScreen(this.x,this.newY),r.x=i.widthVirtualToScreen(this.width)));this.initialized=!0}if(this.settings.textAlign&&(n.textAlign=this.settings.textAlign,this.settings.textAlign==="center"?e.x=e.x+r.x/2:this.settings.textAlign==="right"&&(e.x=e.x+r.x)),this.settings.wrapText)for(f=i.heightVirtualToScreen(this.settings.fontSizeVirtual),this.screenFontSize=f,n.textBaseline="middle",y=e.y+f*h/2,b=0;b<this.text.length;b++)g(this.text[b],n,e.x,y,f,this.settings.fontName),y+=f*h;else this.settings.textBaseline&&(n.textBaseline=this.settings.textBaseline),g(this.text,n,e.x,y,f,this.settings.fontName)};this.isVisible=function(n){var t=this.y+this.height,i;return this.width>0?(i=this.x+this.width,Math.max(this.x,n.Left)<=Math.min(i,n.Right)&&Math.max(this.y,n.Top)<=Math.min(t,n.Bottom)):Math.max(this.y,n.Top)<=Math.min(t,n.Bottom)};this.prototype=new i(n,t,r,u,f,c?c:0,o)}function ot(n,t,r,u,f,e,o,s,h){this.base=i;this.base(n,t,r,u,f,e*10,e);this.settings=h;this.text=o;this.render=function(n,t,i,r){function e(n,t,i,r,u,f){var h,c;if(f=f||0,f<=0){n.fillText(t,i,r);return}for(var o=t.split(" "),s=0,e=1;o.length>0&&e<=o.length;)h=o.slice(0,e).join(" "),c=n.measureText(h).width,c>f?(e==1&&(e=2),n.fillText(o.slice(0,e-1).join(" "),i,r+u*s),s++,o=o.splice(e-1),e=1):e++;e>0&&n.fillText(o.join(" "),i,r+u*s)}var f=i.pointVirtualToScreen(this.x,this.y),u;n.fillStyle=h.fillStyle;n.font=r.y+"pt "+h.fontName;n.textBaseline="top";u=i.heightVirtualToScreen(this.height);e(n,this.text,f.x,f.y,u,s*u)};this.prototype=new i(n,t,r,u,f,e*10,e)}function h(t,r,u,f,e,o,s,h,c){var l;this.base=i;this.base(t,r,u,e,o,s,h);this.onload=c;this.isLoading=!0;l=new Image;this.img=l;this.img.isLoaded=!1;var a=this,v=function(){var i,n,r,u,t;l.isLoading=!1;l.isRemoved?(delete l.isRemoved,delete l.isLoaded):(l.naturalHeight&&(i=a.width/a.height,n=l.naturalWidth/l.naturalHeight,i>n?(r=n*a.height,t=(a.width-r)/2,a.x+=t,a.width=r):i<n&&(u=a.width/n,t=(a.height-u)/2,a.y+=t,a.height=u)),l.isLoaded=!0,a.onLoad&&a.onLoad(),a.vc.requestInvalidate())},y=function(){if(l.isFallback)throw"Cannot load an image!";else l.isFallback=!0,l.src=n.Settings.fallbackImageUri};this.img.addEventListener("load",v,!1);c&&this.img.addEventListener("load",c,!1);this.img.addEventListener("error",y,!1);this.img.src=f;this.render=function(n,t,i,r,u){if(this.img.isLoaded){var f=i.pointVirtualToScreen(this.x,this.y);n.globalAlpha=u;n.drawImage(this.img,f.x,f.y,r.x,r.y)}};this.onRemove=function(){this.img.removeEventListener("load",v,!1);this.img.removeEventListener("error",y,!1);this.onload&&this.img.removeEventListener("load",this.onload,!1);this.img.isRemoved=!0;delete this.img};this.prototype=new i(t,r,u,e,o,s,h)}function st(n,t,i,r,u,f,o,s,c){this.base=e;this.base(n,t,i,u,f,o,s);this.imageSources=r;this.changeZoomLevel=function(r,e){var l=this.imageSources.length;if(l==0)return null;for(;--l>=0;)if(this.imageSources[l].zoomLevel<=e)return this.imageSources[l].zoomLevel===r?null:{zoomLevel:this.imageSources[l].zoomLevel,content:new h(n,t,i+"@"+this.imageSources[l].zoomLevel,this.imageSources[l].imageSource,u,f,o,s,c)};return null};this.prototype=new e(n,t,i,u,f,o,s)}function r(n,t,r,u,f,e,o,s){this.base=i;this.base(n,t,r,u,f,e,o);this.initializeContent=function(n){this.content=n;n&&(n.style.position="absolute",n.style.overflow="hidden",n.style.zIndex=s)};this.onIsRenderedChanged=function(){this.content&&(this.isRendered?(this.content.isAdded||(this.vc.element[0].appendChild(this.content),this.content.isAdded=!0),this.content.style.display="block"):this.content.style.display="none")};this.render=function(n,t,i,r,u){if(this.content){var f=i.pointVirtualToScreen(this.x,this.y),w=i.height,b=i.width,a=0,v=0,y=r.y,p=r.x,s=0,h=w,c=f.y,l=f.y+r.y,e=Math.max(s,c),o=Math.min(h,l);e<=o&&(a=e-f.y,y=o-f.y);s=0;h=b;c=f.x;l=f.x+r.x;e=Math.max(s,c);o=Math.min(h,l);e<=o&&(v=e-f.x,p=o-f.x);this.content.style.left=f.x+"px";this.content.style.top=f.y+"px";this.content.style.width=r.x+"px";this.content.style.height=r.y+"px";this.content.style.clip="rect("+a+"px,"+p+"px,"+y+"px,"+v+"px)";this.content.style.opacity=u;this.content.style.filter="alpha(opacity="+u*100+")"}};this.onRemove=function(){if(this.content)try{this.content.isAdded&&(this.content.src&&(this.content.src=""),this.vc.element[0].removeChild(this.content),this.content.isAdded=!1)}catch(n){alert(n.Description)}};this.prototype=new i(n,t,r,u,f,e,o)}function ht(t,i,u,f,e,o,s,h,c){var l,a;this.base=r;this.base(t,i,u,f,e,o,s,c);l=$("<div><\/div>",{id:"citext_"+u,"class":"contentItemDescription"}).appendTo(t);l[0].addEventListener("mousemove",n.Common.preventbubble,!1);l[0].addEventListener("mousedown",n.Common.preventbubble,!1);l[0].addEventListener("DOMMouseScroll",n.Common.preventbubble,!1);l[0].addEventListener("mousewheel",n.Common.preventbubble,!1);a=$("<div style='position:relative;' class='text'><\/div>");a.html(marked(h)).appendTo(l);this.initializeContent(l[0]);this.render=function(t,i,r,u,f){var e=u.y/n.Settings.contentItemDescriptionNumberOfLines;l.css("font-size",e+"px");this.prototype.render.call(this,t,i,r,u,f)};this.onRemove=function(){this.prototype.onRemove.call(this);l[0].removeEventListener("mousemove",n.Common.preventbubble,!1);l[0].removeEventListener("mouseup",n.Common.preventbubble,!1);l[0].removeEventListener("mousedown",n.Common.preventbubble,!1);l[0].removeEventListener("DOMMouseScroll",n.Common.preventbubble,!1);l[0].removeEventListener("mousewheel",n.Common.preventbubble,!1);l=undefined};this.prototype=new r(t,i,u,f,e,o,s,c)}function ct(n,t,i,u,f,e,o,s,h){var l="http://docs.google.com/viewer?url=",c;this.base=r;this.base(n,t,i,f,e,o,s,h);c=document.createElement("iframe");c.setAttribute("id",i);u.match("/^"+l+"/")||(u=l+u);u+=u.indexOf("?")==-1?"?&embedded=true&wmode=opaque":"&embedded=true&wmode=opaque";c.setAttribute("src",u);c.setAttribute("visible","true");c.setAttribute("controls","true");this.initializeContent(c);this.prototype=new r(n,t,i,f,e,o,s,h)}function lt(n,t,i,u,f,e,o,s,h){this.base=r;this.base(n,t,i,f,e,o,s,h);var c=document.createElement("iframe");c.setAttribute("id",i);u+=u.indexOf("?")==-1?"?wmode=opaque":"&wmode=opaque";c.setAttribute("src",u);c.setAttribute("visible","true");c.setAttribute("controls","true");this.initializeContent(c);this.prototype=new r(n,t,i,f,e,o,s,h)}function at(n,t,i,u,f,e,o,s,h){this.base=r;this.base(n,t,i,f,e,o,s,h);var c=document.createElement("audio");c.setAttribute("id",i);c.setAttribute("src",u);c.setAttribute("visible","true");c.setAttribute("controls","true");this.initializeContent(c);this.prototype=new r(n,t,i,f,e,o,s,h)}function vt(n,t,i,u,f,e,o,s,h){this.base=r;this.base(n,t,i,f,e,o,s,h);var c=document.createElement("iframe");c.setAttribute("id",i);c.setAttribute("src",u);this.initializeContent(c);this.prototype=new r(n,t,i,f,e,o,s,h)}function yt(n,t,i,u,f,e,o,s,h){this.base=r;this.base(n,t,i,f,e,o,s,h);var l=u.split(" "),c=document.createElement("iframe");c.setAttribute("id",i);c.setAttribute("src",l[0]);c.setAttribute("scrolling","no");c.setAttribute("frameborder","0");c.setAttribute("sandbox","allow-forms allow-scripts");this.initializeContent(c);this.render=function(n,t,i,r,u){if(this.content){var s=i.pointVirtualToScreen(this.x,this.y),f=parseFloat(l[1]),e=parseFloat(l[2]),o=r.x/f;e/f>r.y/r.x&&(o=r.y/e);this.content.style.left=s.x+r.x/2+"px";this.content.style.top=s.y+r.y/2+"px";this.content.style.marginLeft=-f/2+"px";this.content.style.marginTop=-e/2+"px";this.content.style.width=f+"px";this.content.style.height=e+"px";this.content.style.opacity=u;this.content.style.filter="alpha(opacity="+u*100+")";this.content.style.webkitTransform="scale("+o+")";this.content.style.msTransform="scale("+o+")";this.content.style.MozTransform="scale("+o+")"}};this.prototype=new r(n,t,i,f,e,o,s,h)}function pt(i,u,f,e,o,s,h,c,l,a,v){var y=this,p;this.base=r;this.base(i,f,e,s,h,c,l,a);this.onload=v;this.nAttempts=0;this.timeoutHandles=[];p=document.createElement("div");p.setAttribute("id",e);p.setAttribute("style","color: white");this.initializeContent(p);this.viewer=new Seadragon.Viewer(p);this.viewer.elmt.addEventListener("mousemove",n.Common.preventbubble,!1);this.viewer.elmt.addEventListener("mousedown",n.Common.preventbubble,!1);this.viewer.elmt.addEventListener("DOMMouseScroll",n.Common.preventbubble,!1);this.viewer.elmt.addEventListener("mousewheel",n.Common.preventbubble,!1);this.viewer.addEventListener("open",function(){y.onload&&y.onload();y.vc.requestInvalidate()});this.viewer.addEventListener("resize",function(n){y.viewer.setDashboardEnabled(n.elmt.clientWidth>250)});this.onSuccess=function(t){var i,r;if(t.error){y.showFallbackImage();return}if(i=t.content,i.ready){for(r=0;r<y.timeoutHandles.length;r++)clearTimeout(y.timeoutHandles[r]);y.viewer.openDzi(i.dzi)}else i.failed?y.showFallbackImage():y.nAttempts<n.Settings.seadragonMaxConnectionAttempts?(y.viewer.showMessage("Loading "+Math.round(100*i.progress)+"% done."),y.timeoutHandles.push(setTimeout(y.requestDZI,n.Settings.seadragonRetryInterval))):y.showFallbackImage()};this.onError=function(){y.nAttempts<n.Settings.seadragonMaxConnectionAttempts?y.timeoutHandles.push(setTimeout(y.requestDZI,n.Settings.seadragonRetryInterval)):y.showFallbackImage()};this.requestDZI=function(){y.nAttempts++;$.ajax({url:n.Settings.seadragonServiceURL+encodeURIComponent(o),dataType:"jsonp",success:y.onSuccess,error:y.onError})};this.render=function(n,t,i,r,u){y.viewer.isFullPage()||(this.prototype.render.call(this,n,t,i,r,u),y.viewer.viewport&&(y.viewer.viewport.resize({x:r.x,y:r.y}),y.viewer.viewport.update()))};this.onRemove=function(){y.viewer.close();this.prototype.onRemove.call(this)};this.showFallbackImage=function(){for(var n=0;n<y.timeoutHandles.length;n++)clearTimeout(y.timeoutHandles[n]);y.onRemove();t.removeChild(u,y.id);t.addImage(u,f,e,s,h,c,l,o)};y.requestDZI();this.prototype=new r(i,f,e,s,h,c,l,a)}function wt(n,t,r,u,f,e,o,s){var h=this,c;h.base=i;h.base(n,t,r,f,e,o,s);c=function(){h.vc.requestInvalidate()};h.img=new Image;h.img.addEventListener("load",c,!1);h.img.src=u;h.render=function(n,t,i,r,u){if(h.img.complete){var f=i.pointVirtualToScreen(h.x,h.y),e=i.pointVirtualToScreen(h.x+h.width,h.y+h.height),tt=e.x-f.x,it=e.y-f.y,w=h.img.width,b=h.img.height,k=i.width,d=i.height,o=tt/w,s=it/b,c=Math.floor(Math.max(0,-f.x)/o),l=Math.floor(Math.max(0,-f.y)/s),rt=Math.floor(Math.max(0,e.x-k)/o),ut=Math.floor(Math.max(0,e.y-d)/s),ft=c,et=l,a=w-c-rt,v=b-l-ut,y=c>0?c*o+f.x:f.x,p=l>0?l*s+f.y:f.y,g=a*o,nt=v*s;n.globalAlpha=u;a===1&&v===1&&(y=Math.max(0,f.x),p=Math.max(0,f.y),g=Math.min(k,e.x)-y,nt=Math.min(d,e.y)-p);h.img.naturalWidth&&h.img.naturalHeight&&n.drawImage(h.img,ft,et,a,v,y,p,g,nt)}};h.onRemove=function(){h.img.removeEventListener("load",c,!1)};h.prototype=new i(n,t,r,f,e,o,s)}function bt(i,r,u,f){var e=f.timeEnd-f.timeStart;return t.addChild(i,new ft(i.vc,r,u,f.timeStart,f.top,e,f.height,{strokeStyle:f.strokeStyle?f.strokeStyle:n.Settings.timelineStrokeStyle,lineWidth:n.Settings.timelineLineWidth,fillStyle:n.Settings.timelineColor?n.Settings.timelineColor:f.fillStyle,opacity:typeof f.opacity!="undefined"?f.opacity:1},f),!0)}function c(i,r,s,c,l,a,v,y){var it;this.base=e;this.base(i,r,s,c,l,a,v);this.guid=y.id;this.type="contentItem";this.contentItem=y;var rt=v*n.Settings.contentItemTopTitleHeight*.8,b=v*n.Settings.contentItemMediaHeight,ut=n.Settings.contentItemFontHeight*v,p=a*n.Settings.contentItemContentWidth,w=(a-p)/2,g=v*n.Settings.contentItemVerticalMargin,et=l+g,ft=g*.4,ot=et+b+ft,st=c+a-w,nt=v*n.Settings.contentItemSourceHeight*.8,ht=ot+g+nt,tt=t.addRectangle(this,r,s+"__rect__",c,l,a,v,{strokeStyle:n.Settings.contentItemBoundingBoxBorderColor,lineWidth:n.Settings.contentItemBoundingBoxBorderWidth*a,fillStyle:n.Settings.contentItemBoundingBoxFillColor,isLineWidthVirtual:!0});this.reactsOnMouse=!0;this.onmouseenter=function(){tt.settings.strokeStyle=n.Settings.contentItemBoundingHoveredBoxBorderColor;this.vc.currentlyHoveredContentItem=this;this.vc.requestInvalidate()};this.onmouseleave=function(){tt.settings.strokeStyle=n.Settings.contentItemBoundingBoxBorderColor;this.vc.currentlyHoveredContentItem=null;this.isMouseIn=!1;this.vc.requestInvalidate()};this.onmouseclick=function(n){return f(this,n,1)};it=this;this.changeZoomLevel=function(f,e){var lt=it.newY,et=lt+g,bt=et+b+ft,at=bt+g+nt,dt,vt,yt,gt,pt,wt,ct,ht,st,ni,ti;if(e>=n.Settings.contentItemShowContentZoomLevel){if(f>=n.Settings.contentItemShowContentZoomLevel)return null;var l=new o(i,r,s+"__content",c,lt,a,v),ot=s+"__media__",kt=null;return this.contentItem.mediaType.toLowerCase()==="image"||this.contentItem.mediaType.toLowerCase()==="picture"?kt=t.addImage(l,r,ot,c+w,et,p,b,this.contentItem.uri):this.contentItem.mediaType.toLowerCase()==="deepimage"?kt=t.addSeadragonImage(l,r,ot,c+w,et,p,b,n.Settings.mediaContentElementZIndex,this.contentItem.uri):this.contentItem.mediaType.toLowerCase()==="video"?t.addVideo(l,r,ot,this.contentItem.uri,c+w,et,p,b,n.Settings.mediaContentElementZIndex):this.contentItem.mediaType.toLowerCase()==="audio"?(et+=n.Settings.contentItemAudioTopMargin*v,b=v*n.Settings.contentItemAudioHeight,k(l,r,ot,this.contentItem.uri,c+w,et,p,b,n.Settings.mediaContentElementZIndex)):this.contentItem.mediaType.toLowerCase()==="pdf"?t.addPdf(l,r,ot,this.contentItem.uri,c+w,et,p,b,n.Settings.mediaContentElementZIndex):this.contentItem.mediaType.toLowerCase()==="skydrive-document"?t.addSkydriveDocument(l,r,ot,this.contentItem.uri,c+w,et,p,b,n.Settings.mediaContentElementZIndex):this.contentItem.mediaType.toLowerCase()==="skydrive-image"?t.addSkydriveImage(l,r,ot,this.contentItem.uri,c+w,et,p,b,n.Settings.mediaContentElementZIndex):n.Extensions.mediaTypeIsExtension(y.mediaType)&&t.addExtension(y.mediaType,l,r,ot,c+w,et,p,b,n.Settings.mediaContentElementZIndex,this.contentItem.uri),dt=this.contentItem.title,u(l,r,s+"__title__",c+w,at,at+rt/2,.9*rt,dt,{fontName:n.Settings.contentItemHeaderFontName,fillStyle:n.Settings.contentItemHeaderFontColor,textBaseline:"middle",textAlign:"center",opacity:1,wrapText:!0,numberOfLines:1},p),vt=this.contentItem.attribution,yt=this.contentItem.mediaSource,vt&&(gt=function(t,f,e){var o=u(l,r,s+"__source__",t,e,e+nt/2,.9*nt,vt,{fontName:n.Settings.contentItemHeaderFontName,fillStyle:n.Settings.contentItemSourceFontColor,textBaseline:"middle",textAlign:"right",opacity:1,adjustWidth:!0},f);yt&&(o.reactsOnMouse=!0,o.onmouseclick=function(){return i.element.css("cursor","default"),window.open(yt),!0},o.onmouseenter=function(){this.settings.fillStyle=n.Settings.contentItemSourceHoveredFontColor;this.vc.requestInvalidate();this.vc.element.css("cursor","pointer")},o.onmouseleave=function(){this.settings.fillStyle=n.Settings.contentItemSourceFontColor;this.vc.requestInvalidate();this.vc.element.css("cursor","default")})},gt(c+w,p,bt)),pt=at+rt+g,wt=d(l,r,s+"__description__",c+w,pt,p,ut,this.contentItem.description,30,{}),n.Authoring.isEnabled&&(ct=(l.y+l.height-wt.y-wt.height)*.75,ht=t.addImage(l,r,s+"__edit",l.x+l.width-1.25*ct,pt+ut,ct,ct,"/images/edit.svg"),ht.reactsOnMouse=!0,ht.onmouseclick=function(){return n.Authoring.isActive=!0,n.Authoring.mode="editContentItem",n.Authoring.contentItemMode="editContentItem",n.Authoring.selectedExhibit=it.parent.parent.parent,n.Authoring.selectedContentItem=it.contentItem,!0},ht.onmouseenter=function(){this.vc.element.css("cursor","pointer");this.vc.element.attr("title","Edit Artifact");tt.settings.strokeStyle="yellow"},ht.onmouseleave=function(){this.vc.element.css("cursor","default");this.vc.element.attr("title","");tt.settings.strokeStyle=n.Settings.contentItemBoundingHoveredBoxBorderColor}),{zoomLevel:n.Settings.contentItemShowContentZoomLevel,content:l}}if(st=e,st>=n.Settings.contentItemThumbnailMaxLevel){if(f>=n.Settings.contentItemThumbnailMaxLevel&&f<n.Settings.contentItemShowContentZoomLevel)return null;st=n.Settings.contentItemThumbnailMaxLevel}else if(st<=n.Settings.contentItemThumbnailMinLevel){if(f<=n.Settings.contentItemThumbnailMinLevel&&f>0)return null;st=n.Settings.contentItemThumbnailMinLevel}return ni=1<<st,ti=n.Settings.contentItemThumbnailBaseUri+"x"+ni+"/"+y.guid+".png",{zoomLevel:e,content:new h(i,r,s+"@1",ti,c,lt,a,v)}};this.prototype=new e(i,r,s,c,l,a,v)}function kt(i,r,s,c,l,a,v,w){var g,l,k;for(this.base=y,this.base(i,r,s,c,l,a,{strokeStyle:n.Settings.infoDotBorderColor,lineWidth:n.Settings.infoDotBorderWidth*a,fillStyle:n.Settings.infoDotFillColor,isLineWidthVirtual:!0,showCirca:w.isCirca}),this.guid=w.guid,this.type="infodot",this.isBuffered=w.isBuffered,this.contentItems=v,this.hasContentItems=!1,this.infodotDescription=w,this.title=w.title,this.isCirca=w.isCirca,this.opacity=typeof w.opacity!="undefined"?w.opacity:1,v.sort(function(n,t){return typeof n.order!="undefined"&&typeof t.order=="undefined"?-1:typeof n.order=="undefined"&&typeof t.order!="undefined"?1:typeof n.order=="undefined"&&typeof t.order=="undefined"?0:n.order<t.order?-1:n.order>t.order?1:0}),g=0;g<v.length;g++)v[g].order=g;l=this.newY+a;k=a-n.Settings.infoDotHoveredBorderWidth*a;this.outerRad=a;this.reactsOnMouse=!0;this.tooltipEnabled=!0;this.tooltipIsShown=!1;this.onmousehover=function(){this.vc.currentlyHoveredInfodot=this;this.vc.requestInvalidate()};this.onmouseclick=function(n){return f(this,n,1)};this.onmouseenter=function(){this.settings.strokeStyle=n.Settings.infoDotHoveredBorderColor;this.settings.lineWidth=n.Settings.infoDotHoveredBorderWidth*a;this.vc.requestInvalidate();this.vc.currentlyHoveredTimeline!=null&&(n.Common.stopAnimationTooltip(),this.vc.currentlyHoveredTimeline.tooltipIsShown=!1);$(".bubbleInfo span").text(w.title);this.panelWidth=$(".bubbleInfo").outerWidth();this.panelHeight=$(".bubbleInfo").outerHeight();n.Common.tooltipMode="infodot";this.tooltipEnabled==!0&&this.tooltipIsShown==!1&&(this.tooltipIsShown=!0,$(".bubbleInfo").attr("id","defaultBox"),n.Common.animationTooltipRunning=$(".bubbleInfo").fadeIn());this.vc.cursorPosition=c;this.vc.currentlyHoveredInfodot=this;this.vc._setConstraintsByInfodotHover(this);this.vc.RaiseCursorChanged()};this.onmouseleave=function(){this.isMouseIn=!1;this.settings.strokeStyle=n.Settings.infoDotBorderColor;this.settings.lineWidth=n.Settings.infoDotBorderWidth*a;this.vc.requestInvalidate();this.tooltipIsShown==!0&&n.Common.stopAnimationTooltip();this.tooltipIsShown=!1;n.Common.tooltipMode="default";this.vc.currentlyHoveredInfodot=undefined;this.vc._setConstraintsByInfodotHover(undefined);this.vc.RaiseCursorChanged()};this.onmouseclick=function(n){return f(this,n,1)};var rt=!0,b=this,d=new e(i,r,s+"_dlod",c-k,l-k,2*k,2*k);d.removeWhenInvisible=!0;t.addChild(this,d,!1);d.firstLoad=!0;d.changeZoomLevel=function(f,e){var ut=b.newY+a,ht,l,g,nt,tt,gt,pt,y;if(e>=n.Settings.infodotShowContentThumbZoomLevel&&e<n.Settings.infodotShowContentZoomLevel){if(ht=n.UrlNav.getURL(),typeof ht.hash.params!="undefined"&&typeof ht.hash.params.b!="undefined"&&(rt=!1),f>=n.Settings.infodotShowContentThumbZoomLevel&&f<n.Settings.infodotShowContentZoomLevel)return null;if(b.tooltipEnabled=!0,l=null,b.contentItems.length>0&&(l=new o(i,r,s+"__contentItems",d.x,d.newY,2*k,2*k),g=p(b.contentItems,c,ut,k,i,r),g))for(nt=0;nt<g.length;nt++)t.addChild(l,g[nt],!1);return l?(b.hasContentItems=!0,{zoomLevel:e,content:l}):null}if(e>=n.Settings.infodotShowContentZoomLevel){if(f>=n.Settings.infodotShowContentZoomLevel)return null;if(b.tooltipEnabled=!1,b.tooltipIsShown==!0&&(n.Common.stopAnimationTooltip(),b.tooltipIsShown=!1),l=null,b.contentItems.length>0&&(l=new o(i,r,s+"__contentItems",d.x,d.y,2*k,2*k),g=p(b.contentItems,c,ut,k,i,r),g))for(nt=0;nt<g.length;nt++)t.addChild(l,g[nt],!1);if(l==null)return null;var ct=n.Settings.infodotTitleWidth*a*2,wt=n.Settings.infodotTitleHeight*a*2,bt=140/225*a,lt=ut-bt-wt,at="";if(w&&w.title&&w.date)if(tt=n.Dates.convertCoordinateToYear(w.date),tt.regime=="CE"||tt.regime=="BCE"){var it=Number(w.date),tt=n.Dates.convertCoordinateToYear(it),vt=n.Dates.getYMDFromCoordinate(it);it=Math.abs(it);at=it==Math.floor(it)?w.title+"\n("+parseFloat(it.toFixed(2))+" "+tt.regime+")":w.title+"\n("+vt.year+"."+(vt.month+1)+"."+vt.day+" "+tt.regime+")"}else at=w.title+"\n("+parseFloat(tt.year.toFixed(2))+" "+tt.regime+")";if(gt=u(l,r,s+"__title",c-ct/2,lt,lt,wt,at,{fontName:n.Settings.contentItemHeaderFontName,fillStyle:n.Settings.contentItemHeaderFontColor,textBaseline:"middle",textAlign:"center",opacity:1,wrapText:!0,numberOfLines:2},ct),n.Authoring.isEnabled){var v=(lt-b.y)*.75,ft=t.addImage(b,r,s+"__edit",c-v/2,b.y+v*.2,v,v,"/images/edit.svg"),et=t.addImage(b,r,s+"__copy",c-v/2-v*1.3,b.y+v*.2,v,v,"/images/copy.svg");ft.reactsOnMouse=!0;et.reactsOnMouse=!0;ft.onmouseclick=function(){return n.Authoring.isActive=!0,n.Authoring.mode="editExhibit",n.Authoring.selectedExhibit=b,!0};et.onmouseclick=function(){return n.Service.exportExhibit(this.parent.guid).then(function(t){localStorage.setItem("ExportedSchemaVersion",constants.schemaVersion);localStorage.setItem("ExportedExhibit",JSON.stringify(t));localStorage.removeItem("ExportedTimeline");n.Authoring.showMessageWindow('"'+t.title+'" has been copied to your clip-board. You can paste this into a different timeline.')}),!0};ft.onmouseenter=function(){this.vc.element.css("cursor","pointer");this.vc.element.attr("title","Edit Exhibit or Add Artifact");b.settings.strokeStyle="yellow"};ft.onmouseleave=function(){this.vc.element.css("cursor","default");this.vc.element.attr("title","");b.settings.strokeStyle=n.Settings.infoDotBorderColor};et.onmouseenter=function(){this.vc.element.css("cursor","pointer");this.vc.element.attr("title","Copy Exhibit to Clipboard");b.settings.strokeStyle="yellow"};et.onmouseleave=function(){this.vc.element.css("cursor","default");this.vc.element.attr("title","");b.settings.strokeStyle=n.Settings.infoDotBorderColor}}var kt=ut+bt+63/225*a,yt=n.Settings.infodotBibliographyHeight*a*2,dt=ct/3,ot=u(l,r,s+"__bibliography",c-dt/2,kt-yt,kt-yt/2,yt,"Bibliography",{fontName:n.Settings.contentItemHeaderFontName,fillStyle:n.Settings.contentItemHeaderFontColor,textBaseline:"middle",textAlign:"center",opacity:1},dt);if(ot.reactsOnMouse=!0,ot.onmouseclick=function(){return this.vc.element.css("cursor","default"),n.Bibliography.showBibliography({infodot:w,contentItems:b.contentItems},l,s+"__bibliography"),!0},ot.onmouseenter=function(){this.vc.element.css("cursor","pointer");this.vc.element.attr("title","View Links, Sources and Attributions");this.vc.requestInvalidate();this.vc.element.css("cursor","pointer")},ot.onmouseleave=function(){this.vc.element.css("cursor","default");this.vc.element.attr("title","");this.vc.requestInvalidate();this.vc.element.css("cursor","default")},pt=window.location.hash.match("b=([a-z0-9_-]+)"),pt&&rt&&n.Bibliography.showBibliography({infodot:w,contentItems:b.contentItems},l,pt[1]),l)return b.hasContentItems=!0,{zoomLevel:e,content:l}}else{if((b.tooltipEnabled=!0,b.hasContentItems=!1,b.contentItems.length==0)||(y=e,y<=n.Settings.contentItemThumbnailMinLevel&&f<=n.Settings.contentItemThumbnailMinLevel&&f>0))return null;if(y>=n.Settings.contentItemThumbnailMaxLevel){if(f>=n.Settings.contentItemThumbnailMaxLevel&&f<n.Settings.infodotShowContentZoomLevel)return null;y=n.Settings.contentItemThumbnailMaxLevel}if(y<n.Settings.contentItemThumbnailMinLevel)return{zoomLevel:y,content:new o(i,r,s+"__empty",c,ut,0,0)};var l=b.contentItems[0],ni=1<<y,ti=n.Settings.contentItemThumbnailBaseUri+"x"+ni+"/"+l.guid+".png",st=k*260/225;return{zoomLevel:y,content:new h(i,r,s+"@"+y,ti,c-st/2,ut-st/2,st,st)}}};var nt=1/225,tt=252*nt,it=262*nt,ut=3*nt*a,ft=24*nt*a,et=-tt/2*a+c,ot=-it/2*a+l,st=tt/2*a+c,ht=it/2*a+l;this.render=function(t,i,r,u,f){var e;if(this.prototype.render.call(this,t,i,r,u,f),e=r.widthVirtualToScreen(ut),!(e<.5)){var o=b.y+a,h=-tt/2*a+c,l=-it/2*a+o,v=tt/2*a+c,y=it/2*a+o,s=this.width/2,p=this.x+s,w=this.y+s,k=u.x/2,d=r.widthVirtualToScreen(ft),g=r.pointVirtualToScreen(h,l),nt=r.pointVirtualToScreen(v,y);t.lineWidth=e;t.strokeStyle=n.Settings.contentItemBoundingBoxFillColor}};this.isInside=function(t){var r=n.Common.sqr(t.x-this.x-this.width/2)+n.Common.sqr(t.y-this.y-this.height/2),i=this.width/2;return r<=i*i};this.prototype=new y(i,r,s,c,l,a,{strokeStyle:n.Settings.infoDotBorderColor,lineWidth:n.Settings.infoDotBorderWidth*a,fillStyle:n.Settings.infoDotFillColor,isLineWidthVirtual:!0})}function dt(t,i){var r;if(t.type!=="infodot"||t.contentItems.length===0)return null;var f=t.width/2,e=f-n.Settings.infoDotHoveredBorderWidth*f,u=p(t.contentItems,t.x+t.width/2,t.y+t.height/2,e,t.vc,t.layerid);if(!u)return null;for(r=0;r<u.length;r++)if(u[r].id==i)return{id:i,x:u[r].x,y:u[r].y,width:u[r].width,height:u[r].height,parent:t,type:"contentItem",vc:t.vc};return null}function gt(n,i,r,u,f,e,o,s){var h=new kt(n.vc,i,r,u,f,e,o,s);return t.addChild(n,h,!0)}function p(t,i,r,u,f,e){var d=t.length,o,nt,s;if(d<=0)return null;var h=1/225,y=260*h,p=270*h,g=-y/2-38*h,tt=-g,l=60*h,a=l,b=l*u,k=a*u,it=-p/2-9*h-a/2,rt=-it,ut=w(3,a),ft=w(3,a),et=w(3,l),ot=i+u*(g-l/2),st=i+u*(tt-l/2),ht=r+u*(rt-a/2),v=[];for(o=0,nt=Math.min(n.Settings.infodotMaxContentItemsCount,d);o<nt;o++)s=t[o],o===0?v.push(new c(f,e,s.id,-y/2*u+i,-p/2*u+r,y*u,p*u,s)):o>=1&&o<=3?v.push(new c(f,e,s.id,ot,r+u*ut[(o-1)%3],b,k,s)):o>=4&&o<=6?v.push(new c(f,e,s.id,st,r+u*ft[(o-1)%3],b,k,s)):o>=7&&o<=9&&v.push(new c(f,e,s.id,i+u*et[(o-1)%3],ht,b,k,s));return v}function w(n,t){if(n==0)return null;var r=.05*t,i,u,f,e;return n%2==0?(i=-r/2-t,u=r/2,n==4)?(f=i-t-r,e=u+r+t,[f,i,u,e]):[i,u]:(i=-t/2,n>1)?(u=t/2+r,f=i-t-r,[f,i,u]):[i]}var l=$.Event("elementclick"),f,k,tt;t.getVisibleForElement=b;f=function(n,t,i){var r=n.vc.getViewport(),u=b(n,i,r,!0);return l.newvisible=u,l.element=n,n.vc.element.trigger(l),!0};t.CanvasElement=i;t.addRectangle=function(n,i,r,u,f,e,o,h){return t.addChild(n,new s(n.vc,i,r,u,f,e,o,h),!1)};t.addCircle=function(n,i,r,u,f,e,o,s){return t.addChild(n,new y(n.vc,i,r,u,f,e,o),s)};t.addImage=function(n,i,r,u,f,e,o,s,c){if(e<=0||o<=0)throw"Image size must be positive";return t.addChild(n,new h(n.vc,i,r,s,u,f,e,o,c),!1)};t.addLodImage=function(n,i,r,u,f,e,o,s,h){if(e<=0||o<=0)throw"Image size must be positive";return t.addChild(n,new st(n.vc,i,r,s,u,f,e,o,h),!1)};t.addSeadragonImage=function(n,i,r,u,f,e,o,s,h,c){if(e<=0||o<=0)throw"Image size must be positive";return t.addChild(n,new pt(n.vc,n,i,r,h,u,f,e,o,s,c),!1)};t.addExtension=function(i,r,u,f,e,o,s,h,c,l,a){if(s<=0||h<=0)throw"Extension size must be positive";var v=n.Extensions.getInitializer(i);return t.addChild(r,v(r.vc,r,u,f,l,e,o,s,h,c,a),!1)};t.addVideo=function(n,i,r,u,f,e,o,s,h){return t.addChild(n,new lt(n.vc,i,r,u,f,e,o,s,h),!1)};t.addPdf=function(n,i,r,u,f,e,o,s,h){return t.addChild(n,new ct(n.vc,i,r,u,f,e,o,s,h),!1)};k=function(n,i,r,u,f,e,o,s,h){return t.addChild(n,new at(n.vc,i,r,u,f,e,o,s,h),!1)};t.addSkydriveDocument=function(n,i,r,u,f,e,o,s,h){return t.addChild(n,new vt(n.vc,i,r,u,f,e,o,s,h),!1)};t.addSkydriveImage=function(n,i,r,u,f,e,o,s,h){return u.indexOf("https://onedrive.live.com/download?resid=")===0?t.addImage(n,i,r,f,e,o,s,u,null):t.addChild(n,new yt(n.vc,i,r,u,f,e,o,s,h),!1)};t.addText=u;t.addScrollText=d;t.addMultiLineText=nt;t.render=function(i,r,u,f,e){var o,c,h,l,s;if(!i.isVisible(u)){i.isRendered&&a(i);return}if(o=f.vectorVirtualToScreen(i.width,i.height),o.y<=n.Settings.renderThreshold||i.width!=0&&o.x<=n.Settings.renderThreshold){i.isRendered&&a(i);return}for(c=r[i.layerid],i.opacity!=null&&(e*=i.opacity),i.isRendered!=undefined&&i.isRendered||(i.isRendered=!0,i.onIsRenderedChanged&&i.onIsRenderedChanged()),i.render(c,u,f,o,e),h=i.children,l=h.length,s=0;s<l;s++)t.render(h[s],r,u,f,e)};t.addChild=function(n,t){var i=n.width==Infinity||t.x>=n.x&&t.x+t.width<=n.x+n.width&&t.y>=n.y&&t.y+t.height<=n.y+n.height;return n.children.push(t),t.parent=n,t};t.removeChild=function(t,i){for(var r,f=t.children.length,u=0;u<f;u++)if(r=t.children[u],r.id==i)return typeof n.Layout.animatingElements[r.id]!="undefined"&&(delete n.Layout.animatingElements[r.id],n.Layout.animatingElements.length--),t.children.splice(u,1),v(r),r.onRemove&&r.onRemove(),r.parent=null,!0;return!1};tt=function(n){var i=n.children.length,t,r;for(console.log(i),t=0;t<i;t++)r=n.children[t],n.onRemove&&n.onRemove(),r.parent=n.parent};t.clear=v;t.getChild=it;t.CanvasRootElement=rt;t.CanvasRectangle=s;t.CanvasDomItem=r;t.addTimeline=bt;t.getContentItem=dt;t.addInfodot=gt})(n.VCContent||(n.VCContent={}));var t=n.VCContent})(CZ||(CZ={}));
//# sourceMappingURL=vccontent.min.js.map
