var ChronoZoom;(function(n){(function(t){function i(t,i,r){function e(n,t){var i=n.vectorScreenToVirtual(t.xOffset,t.yOffset),r=n.visible;n.visible.centerX=r.centerX-i.x,n.visible.centerY=r.centerY-i.y}function o(n,t){var r=n.visible,u=t.xOrigin+(n.width/2-t.xOrigin)*t.scaleFactor,f=t.yOrigin+(n.height/2-t.yOrigin)*t.scaleFactor,i=n.pointScreenToVirtual(u,f);n.visible.centerX=i.x,n.visible.centerY=i.y,n.visible.scale=r.scale*t.scaleFactor}function h(t,i,r){var f=t.visible,s;return i.Type=="Zoom"?(s=i.Source=="Touch"?r?r:new n.Viewport.Viewport2d(t.aspectRatio,t.width,t.height,new n.Viewport.VisibleRegion2d(f.centerX,f.centerY,f.scale)):new n.Viewport.Viewport2d(t.aspectRatio,t.width,t.height,new n.Viewport.VisibleRegion2d(f.centerX,f.centerY,f.scale)),o(s,i)):(s=r?r:new n.Viewport.Viewport2d(t.aspectRatio,t.width,t.height,new n.Viewport.VisibleRegion2d(f.centerX,f.centerY,f.scale)),e(s,i)),u.coerceVisible(s,i),s}function f(n,t){for(var i=0;i<u.onAnimationUpdated.length;i++)u.onAnimationUpdated[i](n,t)}function s(n){for(var t=0;t<u.onAnimationStarted.length;t++)u.onAnimationStarted[t](n)}this.activeAnimation,this.FPS,this.maximumPermitedScale,this.leftPermitedBound,this.rightPermitedBound,this.topPermitedBound,this.bottomPermitedBound,this.effectiveExplorationZoomConstraint=undefined,window.requestAnimFrame||(window.requestAnimFrame=function(t){window.setTimeout(t,1e3/n.Settings.targetFps)}),this.viewportWidth,this.viewportHeight,this.setVisible=t,this.getViewport=i;var u=this;this.estimatedViewport=undefined,this.recentViewport=undefined,this.onAnimationComplete=[],this.onAnimationUpdated=[],this.onAnimationStarted=[],this.saveScreenParameters=function(n){u.viewportWidth=n.width,u.viewportHeight=n.height},this.coerceVisible=function(n,t){this.coerceVisibleInnerZoom(n,t),this.coerceVisibleOuterZoom(n,t),this.coerceVisibleHorizontalBound(n),this.coerceVisibleVerticalBound(n)},this.coerceVisibleOuterZoom=function(t,i){if(i.Type==="Zoom"){var r=t.visible;n.Common.maxPermitedScale&&r.scale>n.Common.maxPermitedScale&&(i.scaleFactor=n.Common.maxPermitedScale/r.scale,o(t,i))}},this.coerceVisibleHorizontalBound=function(t){var i=t.visible;n.Settings.maxPermitedTimeRange&&(i.centerX>n.Settings.maxPermitedTimeRange.right?i.centerX=n.Settings.maxPermitedTimeRange.right:i.centerX<n.Settings.maxPermitedTimeRange.left&&(i.centerX=n.Settings.maxPermitedTimeRange.left))},this.coerceVisibleVerticalBound=function(t){var i=t.visible;n.Common.maxPermitedVerticalRange&&(i.centerY>n.Common.maxPermitedVerticalRange.bottom?i.centerY=n.Common.maxPermitedVerticalRange.bottom:i.centerY<n.Common.maxPermitedVerticalRange.top&&(i.centerY=n.Common.maxPermitedVerticalRange.top))},this.coerceVisibleInnerZoom=function(t){var f=t.visible,e=f.centerX,o=f.scale,i=undefined,r,u;if(this.effectiveExplorationZoomConstraint)i=this.effectiveExplorationZoomConstraint;else for(r=0;r<n.Settings.deeperZoomConstraints.length;r++)if(u=n.Settings.deeperZoomConstraints[r],u.left<=e&&u.right>e){i=u.scale;break}i&&o<i&&(f.scale=i)},u.updateRecentViewport=function(){var t=i(),r=t.visible;u.recentViewport=new n.Viewport.Viewport2d(t.aspectRatio,t.width,t.height,new n.Viewport.VisibleRegion2d(r.centerX,r.centerY,r.scale))},r.Subscribe(function(t){var r,e,i,o;if(typeof t!="undefined"){if(r=u.activeAnimation,e=r?u.activeAnimation.id:undefined,u.updateRecentViewport(),i=u.recentViewport,t.Type=="Pin"){u.stopAnimation();return}(t.Type=="Pan"||t.Type=="Zoom")&&(o=h(i,t,u.estimatedViewport),u.estimatedViewport||(u.activeAnimation=new n.ViewportAnimation.PanZoomAnimation(i),u.saveScreenParameters(i)),u.activeAnimation.velocity=t.Type=="Pan"?n.Settings.panSpeedFactor*.001:n.Settings.zoomSpeedFactor*.0025,u.activeAnimation.setTargetViewport(o),u.estimatedViewport=o),e!=undefined?f(e,u.activeAnimation.id):s(u.activeAnimation.id),r||u.animationStep(u)}}),u.updateRecentViewport(),this.saveScreenParameters(u.recentViewport),this.stopAnimation=function(){u.estimatedViewport=undefined,u.activeAnimation&&(u.activeAnimation.isForciblyStoped=!0,u.activeAnimation.isActive=!1,f(u.activeAnimation.id,undefined))},this.animationStep=function(i){var e,r,u,o,f;if(i.activeAnimation){if(i.activeAnimation.isActive)window.requestAnimFrame(function(){i.animationStep(i)});else{if(e=i.activeAnimation.id,i.updateRecentViewport(),t(new n.Viewport.VisibleRegion2d(i.recentViewport.visible.centerX,i.recentViewport.visible.centerY,i.recentViewport.visible.scale)),!i.activeAnimation.isForciblyStoped)for(r=0;r<i.onAnimationComplete.length;r++)i.onAnimationComplete[r](e);i.activeAnimation=undefined,i.estimatedViewport=undefined;return}u=i.recentViewport,(i.viewportWidth!=u.width||i.viewportHeight!=u.height)&&i.stopAnimation(),o=i.activeAnimation.produceNextVisible(u),t(o)}this.frames++,this.oneSecondFrames++,f=n.Common.vc.virtualCanvas("getLastEvent"),f!=null&&n.Common.vc.virtualCanvas("mouseMove",f)},this.frames=0,this.oneSecondFrames=0,window.setInterval(function(){u.FPS=u.oneSecondFrames,u.oneSecondFrames=0},1e3),this.PanViewportAccessor=e,this.moveToVisible=function(t,i){var e,o,r;if(i){u.stopAnimation(),u.setVisible(t);return}return e=!1,o=undefined,this.activeAnimation&&(e=this.activeAnimation.isActive,o=this.activeAnimation.id),u.updateRecentViewport(),r=u.recentViewport,this.estimatedViewport=undefined,this.activeAnimation=new n.ViewportAnimation.EllipticalZoom(r.visible,t),u.viewportWidth=r.width,u.viewportHeight=r.height,e?f(o,this.activeAnimation.id):(this.activeAnimation.isActive&&s(this.activeAnimation.id),u.animationStep(u)),this.activeAnimation?this.activeAnimation.id:undefined}}t.ViewportController2=i})(n.ViewportController||(n.ViewportController={}));var t=n.ViewportController})(ChronoZoom||(ChronoZoom={}))