var ChronoZoom;(function(n){(function(t){function h(n){n.left=e.getCoordinateFromDecimalYear(n.FromYear),n.right=e.getCoordinateFromDecimalYear(n.ToYear),n.Exhibits.forEach(function(n){n.x=e.getCoordinateFromDecimalYear(n.Year)}),n.ChildTimelines.forEach(function(t){t.ParentTimeline=n,h(t)}),k(n),n.Height?n.Height/=100:n.AspectRatio||n.Height||(n.Height=.4)}function k(n){n.ID==i.cosmosTimelineID&&(n.AspectRatio=10)}function c(n,t,r){var y=i.timelineHeaderSize+2*i.timelineHeaderMargin,s=n.right-n.left,e,o;n.width=s,n.AspectRatio&&!n.height&&(n.height=s/n.AspectRatio),n.ChildTimelines.forEach(function(t){t.AspectRatio?t.height=(t.right-t.left)/t.AspectRatio:n.height&&t.Height&&(t.height=n.height*t.Height),c(t,s,r)}),n.height||(e=undefined,n.ChildTimelines.forEach(function(n){if(n.Height&&!n.AspectRatio){var t=n.height/n.Height;(!e||e<t)&&(e=t)}}),e&&(n.ChildTimelines.forEach(function(n){if(n.Height&&!n.AspectRatio){var t=e*n.Height/n.height;t>1&&(n.realY*=t,a(n,t,r))}}),n.height=e));var v=g(n),w=d(n),u=l(n,v);if(n.height){if(o=f(n.height,n,r),n.Exhibits.length>0&&w.max-w.min<n.height)while(u.max-u.min>n.height-o.bboxHeight&&v>s/20)v/=1.5,u=l(n,v);if(u.max-u.min>n.height-o.bboxHeight){console.log("Warning: Child timelines and exhibits doesn't fit into parent. Timeline name: "+n.Title);var p=u.max-u.min,h=p/(1-y),o=f(h,n,r);n.height=h}n.titleRect=o}else{var b=u.min,k=u.max,nt=1/i.timelineMinAspect,tt=s/nt,p=Math.max((1-y)*tt,k-b),h=p/(1-y),o=f(h,n,r);n.titleRect=o,n.height=h}n.heightEps=t*i.timelineContentMargin,n.realHeight=n.height+2*n.heightEps,n.realY=0,n.Exhibits.forEach(function(n){n.realY-=u.min}),n.ChildTimelines.forEach(function(n){n.realY-=u.min})}function o(n,t,i){n.forEach(function(n){var s=[],e,u,f,o,h,r;if(t.forEach(function(t){i(n,t)&&s.push({top:t.realY+t.realHeight,bottom:t.realY})}),e=0,s.length>0){for(u=[],s.forEach(function(n){u.push({type:"bottom",value:n.bottom}),u.push({type:"top",value:n.top})}),u.sort(function(n,t){return n.value-t.value}),f=[],o=0,r=0;r<u.length-1;r++)u[r].type=="top"?o++:o--,o==0&&u[r+1].type=="bottom"&&f.push({bottom:u[r].value,top:u[r+1].value});for(h=!1,r=0;r<f.length;r++)if(f[r].top-f[r].bottom>n.realHeight){e=f[r].bottom,h=!0;break}h||(e=u[u.length-1].value)}n.realY=e,t.push(n)})}function l(n,t){var f=[],e=[],i,r,u;return n.ChildTimelines.forEach(function(n){n.Sequence?f.push(n):e.push(n)}),n.Exhibits.forEach(function(i){i.size=t,i.left=i.x-i.size/2,i.right=i.x+i.size/2,i.realHeight=t,i.left<n.left?(i.left=n.left,i.right=i.left+i.size,i.isDeposed=!0):i.right>n.right&&(i.right=n.right,i.left=n.right-i.size,i.isDeposed=!0),i.Sequence?f.push(i):e.push(i)}),f.sort(function(n,t){return n.Sequence-t.Sequence}),i=[],o(f,i,function(n,t){return n.left<t.right}),o(e,i,function(n,t){return!(n.left>=t.right||t.left>=n.right)}),r=Number.MAX_VALUE,u=Number.MIN_VALUE,i.forEach(function(n){n.realY<r&&(r=n.realY),n.realY+n.realHeight>u&&(u=n.realY+n.realHeight)}),i.length==0&&(u=0,r=0),{max:u,min:r}}function d(n){var r=[],t,i;return o(n.ChildTimelines,r,function(n,t){return!(n.left>=t.right||t.left>=n.right)}),t=Number.MAX_VALUE,i=Number.MIN_VALUE,r.forEach(function(n){n.realY<t&&(t=n.realY),n.realY+n.realHeight>i&&(i=n.realY+n.realHeight)}),r.length==0&&(i=0,t=0),{max:i,min:t}}function a(n,t,i){if(t<1)throw"Only extending of content is allowed";n.height*=t,n.realHeight=n.height+2*n.heightEps,n.titleRect=f(n.height,n,i),n.ChildTimelines.forEach(function(n){n.realY*=t,n.AspectRatio||a(n,t,i)}),n.Exhibits.forEach(function(n){n.realY*=t})}function v(n){n.y=n.realY+n.heightEps,n.Exhibits.forEach(function(t){t.y=t.realY+t.size/2+n.y}),n.ChildTimelines.forEach(function(t){t.realY+=n.y,v(t)})}function g(n){return(n.right-n.left)/20}function f(n,t,r){var o=t.right-t.left;r.font="100pt "+i.timelineHeaderFontName;var s=r.measureText(t.Title),f=i.timelineHeaderSize*n,e=f*s.width/100,u=Math.min(n,o)*i.timelineHeaderMargin;return e+2*u>o&&(e=o-2*u,f=e*100/s.width),{width:e,height:f,marginTop:n-f-u,marginLeft:u,bboxWidth:e+2*u,bboxHeight:f+2*u}}function y(n,t){var r=nt(t),i=s.addTimeline(n,"layerTimelines","t"+t.UniqueID,{timeStart:t.left,timeEnd:t.right,top:t.y,height:t.height,header:t.Title,fillStyle:"rgba(0,0,0,0.25)",titleRect:t.titleRect,strokeStyle:r,regime:t.Regime});t.Exhibits.forEach(function(n){var t,r=[],u;n.ContentItems||(n.ContentItems=[]),n.ContentItems.forEach(function(n){var i=n.MediaType;i=="Picture"?i="image":i=="Video"&&(i="video"),t=p(n),r.push({id:"c"+n.UniqueID,title:n.Title,mediaUrl:n.Uri,mediaType:i,description:n.Caption,date:t,guid:n.ID,attribution:n.Attribution,mediaSource:n.MediaSource,order:n.Order?n.Order:0})}),t=p(n),u=s.addInfodot(i,"layerInfodots","e"+n.UniqueID,(n.left+n.right)/2,n.y,.8*n.size/2,r,{title:n.Title,date:t,guid:n.ID})}),t.ChildTimelines.forEach(function(n){y(i,n)})}function p(n){var t;return n.Year?(t=n.Year,t<0&&(t<-999999999?(t/=-1e9,t+=" GA"):t<-999999?(t/=-1e6,t+=" MA"):t<-999?(t/=-1e3,t+=" KA"):(t/=-1,t+=" BCE"))):t=n.Date,t}function r(n,t){if(n.ID==t)return 0;if(!n.ParentTimeline)return-1;for(var r=0,i=n;i.ParentTimeline&&i.ID!=t;)i=i.ParentTimeline,r++;return i.ID!=t?-1:r}function u(n,t,i,r){return n==-1?"rgba(255, 255, 255, 0.5)":n==0?t:n%2!=0?i:r}function nt(n){return n.Regime=="Cosmos"?u(r(n,i.cosmosTimelineID),"rgba(152, 108, 157, 1.0)","rgba(94, 78, 129, 1.0)","rgba(149, 136, 193, 1.0)"):n.Regime=="Earth"?u(r(n,i.earthTimelineID),"rgba(81, 127, 149, 1.0)","rgba(11, 110, 131, 1.0)","rgba(117, 163, 174, 1.0)"):n.Regime=="Life"?u(r(n,i.lifeTimelineID),"rgba(73, 150, 73, 1.0)","rgba(13, 106, 49, 1.0)","rgba(139, 167, 97, 1.0)"):n.Regime=="Pre-history"?u(r(n,i.prehistoryTimelineID),"rgba(237, 145, 50, 1.0)","rgba(193, 90, 47, 1.0)","rgba(223, 161, 68, 1.0)"):n.Regime=="Humanity"?u(r(n,i.humanityTimelineID),"rgba(212, 92, 70, 1.0)","rgba(140, 72, 69, 1.0)","rgba(207, 124, 111, 1.0)"):"rgba(255, 255, 255, 0.5)"}function tt(n,t){var i,r;if(t.length>0){for(i=t.length-1;i>=0;i--)h(t[i]);for(t.sort(function(n,t){return n.left-t.left}),i=0;i<t.length-1;i++)t[i].ChildTimelines.push(t[i+1]);r=document.createElement("canvas").getContext("2d"),c(t[0],0,r),v(t[0]),it(n,t[0])}}function w(n,t,i){var r=undefined,e,u,f;if(n)for(e=n.ChildTimelines.length,u=0;u<e;u++)if(f=n.ChildTimelines[u],f.ID==t){r=f;break}else if(i==!0&&(r=w(f,t,i),r!=undefined))break;return r}function it(n,t){var i=n.virtualCanvas("getLayerContent");i.beginEdit(),y(i,t),i.endEdit(!0)}var i=n.Settings,s=n.VCContent,e=n.Common,b=n.Viewport;t.Load=tt,t.FindChildTimeline=w})(n.Layout||(n.Layout={}));var t=n.Layout})(ChronoZoom||(ChronoZoom={}))