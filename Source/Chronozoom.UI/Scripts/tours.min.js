var ChronoZoom;(function(n){(function(t){function d(n,t,i,r){this.url=n,this.caption=t,this.lapseTime=i,this.duration=undefined,this.text=r,this.number=0,this.elapsed=0}function h(t){return n.UrlNav.navStringToVisible(t.url,this.vc)}function g(r,u,e,o,s,c,l){function b(n){i&&window.console&&console.log("playing source: "+a.currentSrc),a.pause();try{a.currentTime=n.lapseTime+n.elapsed,i&&window.console&&console.log("audio currentTime is set to "+(n.lapseTime+n.elapsed))}catch(t){window.console&&console.error("currentTime assignment: "+t)}i&&window.console&&console.log("audio element is forced to play"),a.play()}function k(n){v&&clearTimeout(v);var t=n.duration;n.elapsed!=0&&(t=Math.max(t-n.elapsed,0)),self.currentPlace.startTime=(new Date).getTime(),i&&window.console&&console.log("transition to next bookmark will be in "+t+" seconds"),v=setTimeout(w,t*1e3)}function nt(n){if(self.tour_BookmarkStarted.length>0)for(var t=0;t<self.tour_BookmarkStarted.length;t++)self.tour_BookmarkStarted[t](self,n)}function rt(n){if(self.tour_BookmarkFinished.length>0)for(var t=0;t<self.tour_BookmarkFinished.length;t++)self.tour_BookmarkFinished[t](self,n)}function ut(){if(self.tour_TourStarted.length>0)for(var n=0;n<self.tour_TourStarted.length;n++)self.tour_TourStarted[n](self)}function ft(){if(self.tour_TourFinished.length>0)for(var n=0;n<self.tour_TourFinished.length;n++)self.tour_TourFinished[n](self)}var tt,y,a,p,v,w,it,d,g;if(this.title=r,this.bookmarks=u,this.category=s,this.vc=o,this.sequenceNum=l,this.tour_BookmarkStarted=[],this.tour_BookmarkFinished=[],this.tour_TourStarted=[],this.tour_TourFinished=[],tt=!1,y=!1,this.isTourPlayRequested=!1,!u||u.length==0)throw"Tour has no bookmarks";for(this.state="pause",this.currentPlace={type:"goto",bookmark:0},this.self=this,u.sort(function(n,t){return n.lapseTime-t.lapseTime}),this.isTourPlayRequested=!1,p=1;p<u.length;p++)u[p-1].duration=u[p].lapseTime-u[p-1].lapseTime,u[p-1].number=p;u[u.length-1].duration=10,u[u.length-1].number=u.length,w=function(n){self.bookmarks[self.currentPlace.bookmark].elapsed=0,self.currentPlace.bookmark!=self.bookmarks.length-1||n?it(n):(self.state="pause",self.currentPlace={type:"goto",bookmark:0},ft())},this.toggleAudio=function(n){y=n?!0:!1},this.ReinitializeAudio=function(){var f,t,r;for(a&&a.pause(),a=undefined,tt=!1,a=document.createElement("audio"),a.addEventListener("loadedmetadata",function(){a.duration!=Infinity&&(u[u.length-1].duration=a.duration-u[u.length-1].lapseTime),i&&window.console&&console.log("Tour "+self.title+" metadata loaded (readystate 1)")}),a.addEventListener("canplaythrough",function(){self.isAudioLoaded=!0,i&&window.console&&console.log("Tour "+self.title+" readystate 4")}),a.addEventListener("progress",function(){a.buffered.length>0&&i&&window.console&&console.log("Tour "+self.title+" downloaded "+a.buffered.end(a.buffered.length-1)/a.duration)}),a.controls=!1,a.autoplay=!1,a.loop=!1,a.volume=1,a.preload="none",f=c.substring(0,c.length-3),t=0;t<n.Settings.toursAudioFormats.length;t++)r=document.createElement("Source"),r.setAttribute("src",f+n.Settings.toursAudioFormats[t].ext),a.appendChild(r);a.load(),i&&window.console&&console.log("Loading of tour "+self.title+" is queued")},it=function(n){var t=self.currentPlace.bookmark,u=t,r;t=n?Math.max(0,t-1):Math.min(self.bookmarks.length-1,t+1),rt(u),self.currentPlace={type:"goto",bookmark:t},r=self.bookmarks[self.currentPlace.bookmark],t!=0&&(nt(r),y&&self.state==="play"&&self.isAudioLoaded==!0&&b(r)),self.state!="pause"&&self.isAudioLoaded==!0&&k(r),i&&window.console&&console.log("Transitioning to the bm index "+t),self.currentPlace.animationID=e(h(r),d,g,r.url)},d=function(r){var u,e;self.currentPlace&&self.currentPlace.animationID!=undefined&&self.currentPlace.animationID==r&&(u=getURL(),typeof u.hash.params=="undefined"&&(u.hash.params=[]),u.hash.params.tour=t.tour.sequenceNum,hashHandle=!1,n.UrlNav.setURL(u),i&&window.console&&console.log("reached the bookmark index "+self.currentPlace.bookmark),self.currentPlace={type:"bookmark",bookmark:self.currentPlace.bookmark},self.currentPlace.bookmark==0&&(e=self.bookmarks[self.currentPlace.bookmark],nt(e),self.state!="pause"&&(self.isAudioLoaded!=!0?f():(k(e),y&&b(e)))))},g=function(n){self.currentPlace&&self.currentPlace.animationID!=undefined&&self.currentPlace.animationID==n&&(self.pause(),i&&window.console&&console.log("tour interrupted by user during transition"))},this.play=function(){var f,r,s,u;this.state==="pause"&&(i&&window.console&&console.log("tour playback activated"),this.state="play",f=o.virtualCanvas("getViewport").visible,this.currentPlace=this.currentPlace!=null&&this.currentPlace.bookmark!=null&&n.Common.compareVisibles(f,h(this.bookmarks[this.currentPlace.bookmark]))?{type:"bookmark",bookmark:this.currentPlace.bookmark}:{type:"goto",bookmark:this.currentPlace.bookmark},r=this.bookmarks[this.currentPlace.bookmark],s=this.currentPlace.bookmark==0&&this.currentPlace.type=="goto",(this.currentPlace.type=="bookmark"||this.currentPlace.bookmark!=0)&&(nt(r),this.isAudioLoaded==!0&&(k(r),y&&b(r))),this.currentPlace.animationID=e(h(r),d,g,r.url),this.currentPlace.bookmark===0&&s&&ut(),u=getURL(),typeof u.hash.params=="undefined"&&(u.hash.params=[]),typeof u.hash.params.tour=="undefined"&&(u.hash.params.tour=t.tour.sequenceNum,hashHandle=!1,n.UrlNav.setURL(u)))},this.pause=function(){if(this.state==="play"){i&&window.console&&console.log("tour playback paused"),y&&self.isTourPlayRequested&&(self.isTourPlayRequested=!1),v&&(clearTimeout(v),v=undefined),this.state="pause",y&&(a.pause(),i&&window.console&&console.log("audio element is forced to pause"));var n=this.bookmarks[this.currentPlace.bookmark];this.currentPlace.startTime&&(n.elapsed+=((new Date).getTime()-this.currentPlace.startTime)/1e3)}},this.next=function(){self.currentPlace.bookmark!=u.length-1&&(this.state==="play"&&(v&&clearTimeout(v),v=undefined),w(!1))},this.prev=function(){self.currentPlace.bookmark!=0&&(this.state==="play"&&(v&&clearTimeout(v),v=undefined),w(!0))},this.getBookmark=function(){return this.bookmarks[this.currentPlace.bookmark]}}function v(n,i){var u,r;if(n!=undefined){for(u=document.getElementById("tour_control"),u.style.display="block",t.tour=n,t.tour.tour_TourFinished.push(function(n){b(n),f(),c()}),t.tour.toggleAudio(i),r=0;r<t.tour.bookmarks.length;r++)t.tour.bookmarks[r].elapsed=0;t.tour.currentPlace.bookmark=0,i==!0&&(t.tour.ReinitializeAudio(),t.tour.isAudioLoaded=!0),p()}}function y(){f(),self.isTourPlayRequested=!1;var n=document.getElementById("tour_control");n.style.display="none",t.tour&&(c(),$("#bookmarks .header").html(""),t.tour.audio&&(t.tour.audio=undefined)),t.tour=undefined}function f(){t.tour!=undefined&&($("#tour_playpause").attr("src","Images/tour_play_off.jpg"),t.tour.pause(),n.Common.controller.stopAnimation(),a=undefined,l=undefined)}function p(){$("#tour_playpause").attr("src","Images/tour_pause_off.jpg"),t.tour.play()}function w(){var e=$("#tours-content"),u,o,r,i,f,h;for(t.tours.sort(function(n,t){return n.sequenceNum-t.sequenceNum}),u=null,r=0;r<t.tours.length;r++)i=t.tours[r],i.tour_BookmarkStarted.push(function(n,t){nt(n,t)}),i.tour_BookmarkFinished.push(function(n){b(n)}),i.category!==u&&(f=$('<div class="category">'+i.category+"<\/div>").appendTo(e),h=$('<img src="Images/collapse-down.png" class="collapseButton" />').appendTo(f),r==0&&(f.removeClass("category").addClass("categorySelected"),h[0].src="Images/collapse-up.png"),o=$('<div class="itemContainer"><\/div>').appendTo(e),u=i.category),$('<div class="item" tour="'+r+'">'+i.title+"<\/div>").appendTo(o).click(function(){y(),$("#tours").hide("slide",{},"slow"),n.Common.toggleOffImage("e_index"),t.isTourWindowVisible=!1;var i=t.tours[this.getAttribute("tour")];v(i,s),$(".touritem-selected").removeClass("touritem-selected","slow"),$(this).addClass("touritem-selected","slow")});$("#tours-content").accordion({fillSpace:!1,collapsible:!0,autoHeight:!1}),$("#tours-content").bind("accordionchangestart",function(n,t){var i;t.newHeader&&(t.newHeader.removeClass("category"),t.newHeader.addClass("categorySelected"),i=$(".collapseButton",t.newHeader)[0],i&&(i.src="Images/collapse-up.png")),t.oldHeader&&(t.oldHeader.removeClass("categorySelected"),t.oldHeader.addClass("category"),i=$(".collapseButton",t.oldHeader)[0],i&&(i.src="Images/collapse-down.png"))})}function b(){u&&o&&(r&&r.stop(!0,!0),r=$("#bookmarks .slideText").hide("drop",{},"slow",function(){r=undefined}),$("#bookmarks .slideHeader").html(""),o=!1)}function nt(n,t){e||(e=!0,$("#bookmarks .slideText").html(t.text),$("#bookmarks").show("slide",{},"slow")),$("#bookmarks .header").html(n.title),$("#bookmarks .slideHeader").html(t.caption),$("#bookmarks .slideFooter").html(t.number+"/"+n.bookmarks.length),u?($("#bookmarks .slideText").html(t.text),o||(r&&r.stop(!0,!0),r=$("#bookmarks .slideText").show("drop",{},"slow",function(){r=undefined}),o=!0)):$("#bookmarks .slideText").html(t.text)}function c(){$("#bookmarks").hide(),e=!1}function k(){n.Search.isSearchWindowVisible&&n.Search.onSearchClicked(),t.isTourWindowVisible?(n.Common.toggleOffImage("tours_index"),$("#tours").hide("slide",{},"slow")):(n.Common.toggleOnImage("tours_index"),$("#tours").show("slide",{},"slow")),t.isTourWindowVisible=!t.isTourWindowVisible}function tt(n){var f,o,i,s,e,r,u;for(t.tours=[],f=0;f<n.d.length;f++)if(o=!0,i=n.d[f],typeof i.bookmarks!="undefined"&&typeof i.AudioBlobUrl!="undefined"&&i.AudioBlobUrl!=undefined&&i.AudioBlobUrl!=null&&typeof i.Category!="undefined"&&typeof i.Name!="undefined"&&typeof i.Sequence!="undefined"){for(s=[],e=0;e<i.bookmarks.length;e++){if(r=i.bookmarks[e],typeof r.Description=="undefined"||typeof r.LapseTime=="undefined"||typeof r.Name=="undefined"||typeof r.URL=="undefined"){o=!1;break}u=r.URL,u.indexOf("#")!=-1&&(u=u.substring(u.indexOf("#")+1)),s.push(new d(u,r.Name,r.LapseTime,r.Description))}o&&t.tours.push(new g(i.Name,s,it,$("#vc"),i.Category,i.AudioBlobUrl,i.Sequence))}}function it(i,r,u,f){l=r,a=u,t.pauseTourAtAnyAnimation=!1;var e=n.Common.setVisible(i);return e&&f&&(n.Common.setNavigationStringTo={bookmark:f,id:e}),e}function rt(){var n=getURL();typeof n.hash.params!="undefined"&&n.hash.params.tour>t.tours.length||typeof n.hash.params!="undefined"&&typeof n.hash.params.tour!="undefined"&&(t.tours==null&&w(),t.isTourWindowVisible&&k(),t.tour=t.tours[n.hash.params.tour-1],$(".touritem-selected").removeClass("touritem-selected","slow"),v(t.tour,!0),t.tour.audio&&(t.tour.audio.pause(),t.tour.audio.preload="none"),f())}var l,a,r,i;t.isTourWindowVisible=!1;var e=!1,u=!0,o=!0,s=!0;t.tours,t.tour,t.pauseTourAtAnyAnimation=!1,i=!1,t.tourPause=f,t.initializeToursContent=w,t.onTourClicked=k,t.parseTours=tt,t.loadTourFromURL=rt})(n.Tours||(n.Tours={}));var t=n.Tours})(ChronoZoom||(ChronoZoom={}))