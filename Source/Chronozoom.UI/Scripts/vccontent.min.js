var ChronoZoom;(function(n){(function(t){function nt(t,i,r){var e=2*(n.Settings.contentScaleMargin?n.Settings.contentScaleMargin:0),f=r.width-e,o,u,s,h;return f<0&&(f=r.width),o=i*t.width/f,u=r.height-e,u<0&&(u=r.height),s=i*t.height/u,h={centerX:t.x+t.width/2,centerY:t.y+t.height/2,scale:Math.max(o,s)},h}function i(n,t,i,r,u,f,e){this.vc=n,this.id=i,this.layerid=t,this.x=r,this.y=u,this.width=f,this.height=e,this.children=[],this.isVisible=function(n){var t=this.x+this.width,i=this.y+this.height;return Math.max(this.x,n.Left)<=Math.min(t,n.Right)&&Math.max(this.y,n.Top)<=Math.min(i,n.Bottom)},this.isInside=function(n){return n.x>=this.x&&n.x<=this.x+this.width&&n.y>=this.y&&n.y<=this.y+this.height},this.render=function(){}}function e(n,t,i,u,f,e,o,s,h,c){return r(n,new et(n.vc,t,i,u,f,e,o,s,h,c),!1)}function kt(n,t,i,u,f,e,o,s,h){return r(n,new y(n.vc,t,i,u,f,e,o,s,h),!1)}function b(n){n.isRendered=!1,n.onIsRenderedChanged&&n.onIsRenderedChanged();for(var t=n.children.length;--t>=0;)n.children[t].isRendered&&b(n.children[t])}function it(n){for(var r=n.children.length,t,i=0;i<r;i++)t=n.children[i],it(t),t.onRemove&&t.onRemove(),t.parent=null;n.children=[]}function dt(n,t){for(var r=n.children.length,i=0;i<r;i++)if(n.children[i].id==t)return n.children[i];throw"There is no child with id ["+t+"]";}function rt(n,t,r,u,f,e,o){this.base=i,this.base(n,t,r,u,f,e,o),this.isVisible=function(){return this.children.length!=0},this.beginEdit=function(){return this},this.endEdit=function(n){n||this.vc.invalidate()},this.isInside=function(){return!0},this.render=function(t,i,r){var f,u;if(this.vc.breadCrumbs=[],this.isVisible(i)){for(f=this.children.length,u=0;u<f;u++)tt(this.children[u],t,i,r,1);this.vc.breadCrumbs.length>0&&(this.vc.recentBreadCrumb==undefined||this.vc.breadCrumbs[n.breadCrumbs.length-1].vcElement.title!=this.vc.recentBreadCrumb.vcElement.title)?(this.vc.recentBreadCrumb=this.vc.breadCrumbs[n.breadCrumbs.length-1],this.vc.breadCrumbsChanged()):this.vc.breadCrumbs.length==0&&this.vc.recentBreadCrumb!=undefined&&(this.vc.recentBreadCrumb=undefined,this.vc.breadCrumbsChanged())}}}function gt(n){var t=Math.max(n.x,n.y),r,i;if(t<=1)return 0;for(r=t&1?1:0,i=1;i<32;i++)t=t>>>1,t&1&&(r=r>0?i+1:i);return r}function f(n,t,u,f,e,s,h){var c,l,a;this.base=i,this.base(n,t,u,f,e,s,h),this.zoomLevel=0,this.prevContent=null,this.newContent=null,this.asyncContent=null,this.lastRenderTime=0,c=this,this.changeZoomLevel=function(){return null},l=function(n){c.lastRenderTime=new Date,c.prevContent=c.content,c.content=n.content,r(c,c.content,!1),c.prevContent&&(c.prevContent.opacity||(c.prevContent.opacity=1),c.content.opacity=0),c.zoomLevel=n.zoomLevel},a=function(){c.asyncContent&&(l(c.asyncContent),c.asyncContent=null,delete this.onLoad,c.vc.requestInvalidate())},this.render=function(n,t,i,r){var s,f,h,v;if(!this.asyncContent&&(this.prevContent||(s=gt(r),this.zoomLevel!=s&&(f=this.changeZoomLevel(this.zoomLevel,s),f&&(f.content.isLoading?(this.asyncContent=f,f.content.onLoad=a):l(f)))),this.prevContent)){h=new Date,v=h-c.lastRenderTime,c.lastRenderTime=h;var y=v/1600,e=!1,u=this.prevContent.opacity;u=Math.max(0,u-y),u!=this.prevContent.opacity&&(e=!0),u==0?(o(this,this.prevContent.id),this.prevContent=null):this.prevContent.opacity=u,u=this.content.opacity,u=Math.min(1,u+y),e||u==this.content.opacity||(e=!0),this.content.opacity=u,e&&this.vc.requestInvalidate()}},this.onIsRenderedChanged=function(){typeof this.removeWhenInvisible!="undefined"&&this.removeWhenInvisible&&(this.isRendered||(this.asyncContent&&(this.asyncContent=null),this.prevContent&&(o(this,this.prevContent.id),this.prevContent=null),this.newContent&&(o(this,this.newContent.id),this.newContent.content.onLoad=null,this.newContent=null),this.content&&(o(this,this.content.id),this.content=null),this.zoomLevel=0))}}function s(n,t,r,u,f,e,o){this.base=i,this.base(n,t,r,u,f,e,o),this.render=function(){}}function a(n,t,r,u,f,e,o,s){this.base=i,this.base(n,t,r,u,f,e,o),this.settings=s,this.render=function(n,t,i,r,u){var e=i.pointVirtualToScreen(this.x,this.y),o=i.pointVirtualToScreen(this.x+this.width,this.y+this.height),s=Math.max(0,e.x),h=Math.max(0,e.y),c=Math.min(i.width,o.x),l=Math.min(i.height,o.y),v,a,y,f;s<c&&h<l&&(this.settings.fillStyle&&(v=this.settings.gradientOpacity?u*(1-this.settings.gradientOpacity):u,n.globalAlpha=v,n.fillStyle=this.settings.fillStyle,n.fillRect(s,h,c-s,l-h),this.settings.gradientOpacity&&this.settings.gradientFillStyle&&(a=n.createLinearGradient(s,l,c,h),y="rgba(0, 0, 0, 0)",a.addColorStop(0,this.settings.gradientFillStyle),a.addColorStop(1,y),n.globalAlpha=u*this.settings.gradientOpacity,n.fillStyle=a,n.fillRect(s,h,c-s,l-h))),n.globalAlpha=u,this.settings.strokeStyle&&(n.strokeStyle=this.settings.strokeStyle,n.lineWidth=this.settings.lineWidth?this.settings.isLineWidthVirtual?i.widthVirtualToScreen(this.settings.lineWidth):this.settings.lineWidth:1,f=n.lineWidth/2,this.settings.outline&&(e.x+=f,e.y+=f,h+=f,l-=f,s+=f,c-=f,o.x-=f,o.y-=f),e.x>0&&(n.beginPath(),n.moveTo(e.x,h-f),n.lineTo(e.x,l+f),n.stroke()),e.y>0&&(n.beginPath(),n.moveTo(s-f,e.y),n.lineTo(c+f,e.y),n.stroke()),o.x<i.width&&(n.beginPath(),n.moveTo(o.x,h-f),n.lineTo(o.x,l+f),n.stroke()),o.y<i.height&&(n.beginPath(),n.moveTo(s-f,o.y),n.lineTo(c+f,o.y),n.stroke())))}}function ut(t,i,r,u,f,o,s,h,c){this.base=a,this.base(t,i,r,u,f,o,s),this.settings=h,this.parent=undefined,this.currentlyObservedTimelineEvent=t.currentlyObservedTimelineEvent,this.settings.outline=!0,this.type="timeline";var b=c.timeEnd-c.timeStart,v=c.titleRect?c.titleRect.height:n.Settings.timelineHeaderSize*c.height,p=c.titleRect?c.titleRect.marginLeft:n.Settings.timelineHeaderMargin*c.height,y=c.titleRect?c.titleRect.marginTop:(1-n.Settings.timelineHeaderMargin)*c.height-v,w=c.top+y+v/2;this.titleObject=e(this,i,r+"__header__",c.timeStart+p,c.top+y,w,v,c.header,{fontName:n.Settings.timelineHeaderFontName,fillStyle:timelineHeaderFontColor,textBaseline:"middle"}),this.title=this.titleObject.text,this.regime=c.regime,this.settings.gradientOpacity=0,this.settings.gradientFillStyle=c.strokeStyle?c.strokeStyle:n.Settings.timelineBorderColor,this.reactsOnMouse=!0,this.tooltipEnabled=!0,this.tooltipIsShown=!1,this.onmouseclick=function(n){return l(this,n,1)},this.onmousehover=function(){if(this.vc.currentlyHoveredTimeline!=null&&this.vc.currentlyHoveredTimeline.id!=r)try{this.vc.currentlyHoveredInfodot.id}catch(i){stopAnimationTooltip(),this.vc.currentlyHoveredTimeline.tooltipIsShown=!1}if(this.vc.currentlyHoveredTimeline=this,this.settings.strokeStyle=n.Settings.timelineHoveredBoxBorderColor,this.settings.lineWidth=n.Settings.timelineHoveredLineWidth,this.titleObject.settings.fillStyle=timelineHoveredHeaderFontColor,this.settings.hoverAnimationDelta=3/60,this.vc.requestInvalidate(),this.titleObject.initialized==!1){var t=this.vc.getViewport();this.titleObject.screenFontSize=n.Settings.timelineHeaderSize*t.heightVirtualToScreen(this.height)}if(this.tooltipEnabled=this.titleObject.screenFontSize<=timelineTooltipMaxHeaderSize?!0:!1,tooltipMode!="infodot"){if(tooltipMode="timeline",this.tooltipEnabled==!1){stopAnimationTooltip(),this.tooltipIsShown=!1;return}if(this.tooltipIsShown==!1){switch(this.regime){case"Cosmos":$(".bubbleInfo").attr("id","cosmosRegimeBox");break;case"Earth":$(".bubbleInfo").attr("id","earthRegimeBox");break;case"Life":$(".bubbleInfo").attr("id","lifeRegimeBox");break;case"Pre-history":$(".bubbleInfo").attr("id","prehistoryRegimeBox");break;case"Humanity":$(".bubbleInfo").attr("id","humanityRegimeBox")}$(".bubbleInfo span").text(this.title),this.panelWidth=$(".bubbleInfo").outerWidth(),this.panelHeight=$(".bubbleInfo").outerHeight(),this.tooltipIsShown=!0,animationTooltipRunning=$(".bubbleInfo").fadeIn()}}},this.onmouseunhover=function(){this.vc.currentlyHoveredTimeline!=null&&this.vc.currentlyHoveredTimeline.id==r&&(this.vc.currentlyHoveredTimeline=null,this.tooltipIsShown==!0&&tooltipMode=="timeline"&&(tooltipMode="default",stopAnimationTooltip(),$(".bubbleInfo").attr("id","defaultBox"),this.tooltipIsShown=!1)),this.settings.strokeStyle=c.strokeStyle?c.strokeStyle:n.Settings.timelineBorderColor,this.settings.lineWidth=n.Settings.timelineLineWidth,this.titleObject.settings.fillStyle=timelineHeaderFontColor,this.settings.hoverAnimationDelta=-3/60,this.vc.requestInvalidate()},this.base_render=this.render,this.render=function(i,r,u,f,e){var s;this.titleObject.initialized=!1,this.settings.hoverAnimationDelta&&(this.settings.gradientOpacity=Math.min(1,Math.max(0,this.settings.gradientOpacity+this.settings.hoverAnimationDelta))),this.base_render(i,r,u,f,e),this.settings.hoverAnimationDelta&&(this.settings.gradientOpacity==0||this.settings.gradientOpacity==1?this.settings.hoverAnimationDelta=undefined:this.vc.requestInvalidate());var o=u.pointVirtualToScreen(this.x,this.y),h={x:o.x+f.x,y:o.y+f.y},c=u.visible.centerX-n.Settings.timelineCenterOffsetAcceptableImplicity<=this.x+this.width&&u.visible.centerX+n.Settings.timelineCenterOffsetAcceptableImplicity>=this.x&&u.visible.centerY-n.Settings.timelineCenterOffsetAcceptableImplicity<=this.y+this.height&&u.visible.centerY+n.Settings.timelineCenterOffsetAcceptableImplicity>=this.y,l=o.x<n.Settings.timelineBreadCrumbBorderOffset&&h.x>u.width-n.Settings.timelineBreadCrumbBorderOffset||o.y<n.Settings.timelineBreadCrumbBorderOffset&&h.y>u.height-n.Settings.timelineBreadCrumbBorderOffset;if(l&&c){if(s=t.breadCrumbs.length,s>1&&t.breadCrumbs[s-1].vcElement.parent.id==this.parent.id)return;t.breadCrumbs.push({vcElement:this})}}}function v(n,t,r,u,f,e,o){this.base=i,this.base(n,t,r,u-e,f-e,2*e,2*e),this.settings=o,this.isObservedNow=!1,this.render=function(n,t,i,r,u){var f=this.width/2,o=this.x+f,s=this.y+f,e=i.pointVirtualToScreen(o,s),h=i.widthVirtualToScreen(f);n.globalAlpha=u,n.beginPath(),n.arc(e.x,e.y,h,0,Math.PI*2,!0),this.settings.strokeStyle&&(n.strokeStyle=this.settings.strokeStyle,n.lineWidth=this.settings.lineWidth?this.settings.isLineWidthVirtual?i.widthVirtualToScreen(this.settings.lineWidth):this.settings.lineWidth:1,n.stroke()),this.settings.fillStyle&&(n.fillStyle=this.settings.fillStyle,n.fill())},this.isInside=function(n){var t=sqr(n.x-u)+sqr(n.y-f);return t<=e*e}}function ft(n,t,i,r,u,f){var o=$.browser,h=o.msie&&parseInt(o.version,10)>=9;if(h)t.font=u+"pt "+f,t.fillText(n,i,r);else{var s=12,c=u,e=c/s;t.scale(e,e),t.font=s+"pt "+f,t.fillText(n,i/e,r/e),t.scale(1/e,1/e)}}function et(n,t,r,u,f,e,o,s,h,c){this.base=i,this.base(n,t,r,u,f,c?c:0,o),this.text=s,this.baseline=e,this.settings=h,typeof this.settings.textBaseline!="undefined"&&this.settings.textBaseline==="middle"&&(this.baseline=this.y+this.height/2),this.initialized=!1,this.screenFontSize=0,this.render=function(n,t,i,r,u){var e=i.pointVirtualToScreen(this.x,this.y),a=i.pointVirtualToScreen(this.x,this.baseline).y,f,h,b,v,s,nt,it,o,p,w;if(n.globalAlpha=u,n.fillStyle=this.settings.fillStyle,f=r.y,h=1.5,this.screenFontSize!=f&&(this.screenFontSize=f),!this.initialized){if(this.settings.wrapText){for(b=this.settings.numberOfLines?this.settings.numberOfLines:1,this.settings.numberOfLines=b,f=r.y/b/h;;){n.font=f+"pt "+this.settings.fontName;var tt=this.text.split("\n"),k=0,d=[];for(v=0;v<tt.length;v++){var y=tt[v].split(" "),c=0,l="",g,rt=n.measureText(" ").width;for(s=0;s<y.length;s++)g=n.measureText(y[s]),nt=c==0?c+g.width:c+g.width+rt,nt>r.x&&c>0?(d.push(l),c=0,k+=f*h,s--,l=""):(l===""?l=y[s]:l+=" "+y[s],c=nt);d.push(l),k+=f*h}if(k>r.y)f/=1.5;else{this.text=d,it=i.heightScreenToVirtual(f),this.settings.fontSizeVirtual=it;break}}this.screenFontSize=f}else n.font=f+"pt "+this.settings.fontName,this.screenFontSize=f,this.width==0?(o=n.measureText(this.text),r.x=o.width,this.width=i.widthScreenToVirtual(o.width)):(o=n.measureText(this.text),o.width>r.x?(this.height=this.width*r.y/o.width,this.settings.textBaseline==="middle"&&(this.y=this.baseline-this.height/2),f=i.heightVirtualToScreen(this.height),this.screenFontSize=f):typeof this.settings.adjustWidth&&this.settings.adjustWidth&&(p=i.widthScreenToVirtual(o.width),this.settings.textAlign==="center"?this.x=this.x+(this.width-p)/2:this.settings.textAlign==="right"&&(this.x=this.x+this.width-p),this.width=p,e=i.pointVirtualToScreen(this.x,this.y),r.x=i.widthVirtualToScreen(this.width)));this.initialized=!0}if(this.settings.textAlign&&(n.textAlign=this.settings.textAlign,this.settings.textAlign==="center"?e.x=e.x+r.x/2:this.settings.textAlign==="right"&&(e.x=e.x+r.x)),this.settings.wrapText)for(f=i.heightVirtualToScreen(this.settings.fontSizeVirtual),this.screenFontSize=f,n.textBaseline="middle",a=e.y+f*h/2,w=0;w<this.text.length;w++)ft(this.text[w],n,e.x,a,f,this.settings.fontName),a+=f*h;else this.settings.textBaseline&&(n.textBaseline=this.settings.textBaseline),ft(this.text,n,e.x,a,f,this.settings.fontName)},this.isVisible=function(n){var t=this.y+this.height,i;return this.width>0?(i=this.x+this.width,Math.max(this.x,n.Left)<=Math.min(i,n.Right)&&Math.max(this.y,n.Top)<=Math.min(t,n.Bottom)):Math.max(this.y,n.Top)<=Math.min(t,n.Bottom)}}function ot(n,t,r,u,f,e,o,s,h){this.base=i,this.base(n,t,r,u,f,e*10,e),this.settings=h,this.text=o,this.render=function(n,t,i,r){function e(n,t,i,r,u,f){var h,c;if(f=f||0,f<=0){n.fillText(t,i,r);return}for(var o=t.split(" "),s=0,e=1;o.length>0&&e<=o.length;)h=o.slice(0,e).join(" "),c=n.measureText(h).width,c>f?(e==1&&(e=2),n.fillText(o.slice(0,e-1).join(" "),i,r+u*s),s++,o=o.splice(e-1),e=1):e++;e>0&&n.fillText(o.join(" "),i,r+u*s)}var f=i.pointVirtualToScreen(this.x,this.y),u;n.fillStyle=h.fillStyle,n.font=r.y+"pt "+h.fontName,n.textBaseline="top",u=i.heightVirtualToScreen(this.height),e(n,this.text,f.x,f.y,u,s*u)}}function h(t,r,u,f,e,o,s,h,c){var l;this.base=i,this.base(t,r,u,e,o,s,h),this.onload=c,this.isLoading=!0,l=new Image,this.img=l,this.img.isLoaded=!1;var a=this,v=function(){var i,n,r,u,t;l.isLoading=!1,l.isRemoved?(delete l.isRemoved,delete l.isLoaded):(l.naturalHeight&&(i=a.width/a.height,n=l.naturalWidth/l.naturalHeight,i>n?(r=n*a.height,t=(a.width-r)/2,a.x+=t,a.width=r):i<n&&(u=a.width/n,t=(a.height-u)/2,a.y+=t,a.height=u)),l.isLoaded=!0,a.onLoad&&a.onLoad(),a.vc.requestInvalidate())},y=function(){if(l.isFallback)throw"Cannot load an image!";else l.isFallback=!0,l.src=n.Settings.fallbackImageUri};this.img.addEventListener("load",v,!1),c&&this.img.addEventListener("load",c,!1),this.img.addEventListener("error",y,!1),this.img.src=f,this.render=function(n,t,i,r,u){if(this.img.isLoaded){var f=i.pointVirtualToScreen(this.x,this.y);n.globalAlpha=u,n.drawImage(this.img,f.x,f.y,r.x,r.y)}},this.onRemove=function(){this.img.removeEventListener("load",v,!1),this.img.removeEventListener("error",y,!1),this.onload&&this.img.removeEventListener("load",this.onload,!1),this.img.isRemoved=!0,delete this.img}}function st(n,t,i,r,u,e,o,s,c){this.base=f,this.base(n,t,i,u,e,o,s),this.imageSources=r,this.changeZoomLevel=function(r,f){var l=this.imageSources.length;if(l==0)return null;for(;--l>=0;)if(this.imageSources[l].zoomLevel<=f)return this.imageSources[l].zoomLevel===r?null:{zoomLevel:this.imageSources[l].zoomLevel,content:new h(n,t,i+"@"+this.imageSources[l].zoomLevel,this.imageSources[l].imageSource,u,e,o,s,c)};return null}}function u(n,t,r,u,f,e,o,s){this.base=i,this.base(n,t,r,u,f,e,o),this.initializeContent=function(n){this.content=n,n&&(n.style.position="absolute",n.style.overflow="hidden",n.style.zIndex=s)},this.onIsRenderedChanged=function(){this.content&&(this.isRendered?(this.content.isAdded||(this.vc.element[0].appendChild(this.content),this.content.isAdded=!0),this.content.style.display="block"):this.content.style.display="none")},this.render=function(n,t,i,r,u){if(this.content){var f=i.pointVirtualToScreen(this.x,this.y),w=i.height,b=i.width,a=0,v=0,y=r.y,p=r.x,s=0,h=w,c=f.y,l=f.y+r.y,e=Math.max(s,c),o=Math.min(h,l);e<=o&&(a=e-f.y,y=o-f.y),s=0,h=b,c=f.x,l=f.x+r.x,e=Math.max(s,c),o=Math.min(h,l),e<=o&&(v=e-f.x,p=o-f.x),this.content.style.left=f.x+"px",this.content.style.top=f.y+"px",this.content.style.width=r.x+"px",this.content.style.height=r.y+"px",this.content.style.clip="rect("+a+"px,"+p+"px,"+y+"px,"+v+"px)",this.content.style.opacity=u,this.content.style.filter="alpha(opacity="+u*100+")"}},this.onRemove=function(){if(this.content)try{this.content.isAdded&&(this.content.src&&(this.content.src=""),this.vc.element[0].removeChild(this.content),this.content.isAdded=!1)}catch(n){alert(n.Description)}}}function y(t,i,r,f,e,o,s,h,c){var l,a;this.base=u,this.base(t,i,r,f,e,o,s,c),l=$("<div id='citext_"+r+"' class='contentItemDescription'><\/div").appendTo(t),l[0].addEventListener("mousemove",preventbubble,!1),l[0].addEventListener("mousedown",preventbubble,!1),l[0].addEventListener("DOMMouseScroll",preventbubble,!1),l[0].addEventListener("mousewheel",preventbubble,!1),a=$("<div style='position:relative' class='text'><\/div>").html(h).appendTo(l),this.initializeContent(l[0]),this.render=function(t,i,r,u,f){var e=u.y/n.Settings.contentItemDescriptionNumberOfLines;l.css("font-size",e+"px"),y.prototype.render.call(this,t,i,r,u,f)},this.onRemove=function(){y.prototype.onRemove.call(this),l[0].removeEventListener("mousemove",preventbubble,!1),l[0].removeEventListener("mouseup",preventbubble,!1),l[0].removeEventListener("mousedown",preventbubble,!1),l[0].removeEventListener("DOMMouseScroll",preventbubble,!1),l[0].removeEventListener("mousewheel",preventbubble,!1),l=undefined}}function ht(n,t,i,r,f,e,o,s,h){this.base=u,this.base(n,t,i,f,e,o,s,h);var c=document.createElement("iframe");c.setAttribute("id",i),r+=r.indexOf("?")==-1?"?wmode=opaque":"&wmode=opaque",c.setAttribute("src",r),c.setAttribute("visible","true"),c.setAttribute("controls","true"),this.initializeContent(c)}function ct(n,t,i,r,f,e,o,s,h){this.base=u,this.base(n,t,i,f,e,o,s,h);var c=document.createElement("iframe");c.setAttribute("id",i),r+=r.indexOf("?")==-1?"?wmode=opaque":"&wmode=opaque",c.setAttribute("src",r),c.setAttribute("visible","true"),c.setAttribute("controls","true"),this.initializeContent(c)}function lt(n,t,i,r,f,e,o,s,h){this.base=u,this.base(n,t,i,f,e,o,s,h);var c=document.createElement("audio");c.setAttribute("id",i),c.setAttribute("src",r),c.setAttribute("visible","true"),c.setAttribute("controls","true"),this.initializeContent(c)}function p(t,i,r,f,e,s,h,c,l,a,v){var y=this,w;this.base=u,this.base(t,r,f,s,h,c,l,a),this.onload=v,this.nAttempts=0,this.timeoutHandles=[],w=document.createElement("div"),w.setAttribute("id",f),w.setAttribute("style","color: white"),this.initializeContent(w),this.viewer=new Seadragon.Viewer(w),this.viewer.elmt.addEventListener("mousemove",preventbubble,!1),this.viewer.elmt.addEventListener("mousedown",preventbubble,!1),this.viewer.elmt.addEventListener("DOMMouseScroll",preventbubble,!1),this.viewer.elmt.addEventListener("mousewheel",preventbubble,!1),this.viewer.addEventListener("open",function(){y.onload&&y.onload(),y.vc.requestInvalidate()}),this.viewer.addEventListener("resize",function(n){y.viewer.setDashboardEnabled(n.elmt.clientWidth>250)}),this.onSuccess=function(t){var i,r;if(t.error){y.showFallbackImage();return}if(i=t.content,i.ready){for(r=0;r<y.timeoutHandles.length;r++)clearTimeout(y.timeoutHandles[r]);y.viewer.openDzi(i.dzi)}else i.failed?y.showFallbackImage():y.nAttempts<n.Settings.seadragonMaxConnectionAttempts?(y.viewer.showMessage("Loading "+Math.round(100*i.progress)+"% done."),y.timeoutHandles.push(setTimeout(y.requestDZI,n.Settings.seadragonRetryInterval))):y.showFallbackImage()},this.onError=function(){y.nAttempts<n.Settings.seadragonMaxConnectionAttempts?y.timeoutHandles.push(setTimeout(y.requestDZI,n.Settings.seadragonRetryInterval)):y.showFallbackImage()},this.requestDZI=function(){y.nAttempts++,$.ajax({url:n.Settings.seadragonServiceURL+encodeURIComponent(e),dataType:"jsonp",success:y.onSuccess,error:y.onError})},this.render=function(n,t,i,r,u){y.viewer.isFullPage()||(p.prototype.render.call(this,n,t,i,r,u),y.viewer.viewport&&(y.viewer.viewport.resize({x:r.x,y:r.y}),y.viewer.viewport.update()))},this.onRemove=function(){y.viewer.close(),p.prototype.onRemove.call(this)},this.showFallbackImage=function(){for(var n=0;n<y.timeoutHandles.length;n++)clearTimeout(y.timeoutHandles[n]);y.onRemove(),o(i,y.id),vt(i,r,f,s,h,c,l,e)},y.requestDZI()}function ni(t,i,u,f){var e=f.timeEnd-f.timeStart;return r(t,new ut(t.vc,i,u,f.timeStart,f.top,e,f.height,{strokeStyle:f.strokeStyle?f.strokeStyle:n.Settings.timelineStrokeStyle,lineWidth:n.Settings.timelineLineWidth,fillStyle:f.fillStyle},f),!0)}function c(t,i,r,u,o,c,a,v){this.base=f,this.base(t,i,r,u,o,c,a),this.type="contentItem";var d=a*n.Settings.contentItemTopTitleHeight*.8,w=a*n.Settings.contentItemMediaHeight,ut=n.Settings.contentItemFontHeight*a,y=c*n.Settings.contentItemContentWidth,p=(c-y)/2,k=a*n.Settings.contentItemVerticalMargin,b=o+k,tt=k*.4,it=b+w+tt,ft=u+c-p,g=a*n.Settings.contentItemSourceHeight*.8,nt=it+k+g,rt=at(this,i,r+"__rect__",u,o,c,a,{strokeStyle:n.Settings.contentItemBoundingBoxBorderColor,lineWidth:n.Settings.contentItemBoundingBoxBorderWidth*c,fillStyle:n.Settings.contentItemBoundingBoxFillColor,isLineWidthVirtual:!0});this.reactsOnMouse=!0,this.onmouseenter=function(){rt.settings.strokeStyle=n.Settings.contentItemBoundingHoveredBoxBorderColor,this.vc.currentlyHoveredContentItem=this,this.vc.requestInvalidate()},this.onmouseleave=function(){rt.settings.strokeStyle=n.Settings.contentItemBoundingBoxBorderColor,this.vc.currentlyHoveredContentItem=null,this.isMouseIn=!1,this.vc.requestInvalidate()},this.onmouseclick=function(n){return l(this,n,1)},this.changeZoomLevel=function(f,l){var ct,st,ht,lt,ft,at,vt;if(l>=n.Settings.contentItemShowContentZoomLevel){if(f>=n.Settings.contentItemShowContentZoomLevel)return null;var rt=new s(t,i,r+"__content",u,o,c,a),et=r+"__media__",ot=null;return v.mediaType==="image"?ot=yt(rt,i,et,u+p,b,y,w,n.Settings.mediaContentElementZIndex,v.mediaUrl):v.mediaType==="video"?pt(rt,i,et,v.mediaUrl,u+p,b,y,w,n.Settings.mediaContentElementZIndex):v.mediaType==="audio"?(b+=n.Settings.contentItemAudioTopMargin*a,w=a*n.Settings.contentItemAudioHeight,bt(rt,i,et,v.mediaUrl,u+p,b,y,w,n.Settings.mediaContentElementZIndex)):v.mediaType==="pdf"&&wt(rt,i,et,v.mediaUrl,u+p,b,y,w,n.Settings.mediaContentElementZIndex),ct=v.title,e(rt,i,r+"__title__",u+p,nt,nt+d/2,.9*d,ct,{fontName:n.Settings.contentItemHeaderFontName,fillStyle:n.Settings.contentItemHeaderFontColor,textBaseline:"middle",textAlign:"center",wrapText:!0,numberOfLines:1},y),st=v.attribution,st&&(ht=function(u,f,o){var s=e(rt,i,r+"__source__",u,o,o+g/2,.9*g,st,{fontName:n.Settings.contentItemHeaderFontName,fillStyle:n.Settings.contentItemSourceFontColor,textBaseline:"middle",textAlign:"right",adjustWidth:!0},f);v.mediaSource&&(s.reactsOnMouse=!0,s.onmouseclick=function(){return t.element.css("cursor","default"),window.open(v.mediaSource),!0},s.onmouseenter=function(){this.settings.fillStyle=n.Settings.contentItemSourceHoveredFontColor,this.vc.requestInvalidate(),this.vc.element.css("cursor","pointer")},s.onmouseleave=function(){this.settings.fillStyle=n.Settings.contentItemSourceFontColor,this.vc.requestInvalidate(),this.vc.element.css("cursor","default")})},ot?ot.onLoad=function(){var n=this.x,t=this.width,i=this.y+this.height+tt;ht(n,t,i),this.onLoad=null}:ht(u+p,y,it)),lt=nt+d+k,kt(rt,i,r+"__description__",u+p,lt,y,ut,v.description,30,{}),{zoomLevel:n.Settings.contentItemShowContentZoomLevel,content:rt}}if(ft=l,ft>=n.Settings.contentItemThumbnailMaxLevel){if(f>=n.Settings.contentItemThumbnailMaxLevel&&f<n.Settings.contentItemShowContentZoomLevel)return null;ft=n.Settings.contentItemThumbnailMaxLevel}else if(ft<=n.Settings.contentItemThumbnailMinLevel){if(f<=n.Settings.contentItemThumbnailMinLevel&&f>0)return null;ft=n.Settings.contentItemThumbnailMinLevel}return at=1<<ft,vt=n.Settings.contentItemThumbnailBaseUri+"x"+at+"/"+v.guid+".png",{zoomLevel:l,content:new h(t,i,r+"@1",vt,u,o,c,a)}}}function k(t,i,u,o,c,a,y,p){var b;this.base=v,this.base(t,i,u,o,c,a,{strokeStyle:n.Settings.infoDotBorderColor,lineWidth:n.Settings.infoDotBorderWidth*a,fillStyle:n.Settings.infoDotFillColor,isLineWidthVirtual:!0}),this.contentItems=y,this.hasContentItems=!1,y.sort(function(n,t){return n.order-t.order}),b=a-n.Settings.infoDotHoveredBorderWidth*a,this.outerRad=a,this.type="infodot",this.reactsOnMouse=!0,this.tooltipEnabled=!0,this.tooltipIsShown=!1,this.onmouseenter=function(){this.settings.strokeStyle=n.Settings.infoDotHoveredBorderColor,this.settings.lineWidth=n.Settings.infoDotHoveredBorderWidth*a,this.vc.requestInvalidate(),this.vc.currentlyHoveredTimeline!=null&&(stopAnimationTooltip(),this.vc.currentlyHoveredTimeline.tooltipIsShown=!1),$(".bubbleInfo span").text(p.title),this.panelWidth=$(".bubbleInfo").outerWidth(),this.panelHeight=$(".bubbleInfo").outerHeight(),tooltipMode="infodot",this.tooltipEnabled==!0&&this.tooltipIsShown==!1&&(this.tooltipIsShown=!0,$(".bubbleInfo").attr("id","defaultBox"),animationTooltipRunning=$(".bubbleInfo").fadeIn()),this.vc.cursorPosition=o,this.vc.currentlyHoveredInfodot=this,this.vc._setConstraintsByInfodotHover(this),this.vc.RaiseCursorChanged()},this.onmouseleave=function(){this.isMouseIn=!1,this.settings.strokeStyle=n.Settings.infoDotBorderColor,this.settings.lineWidth=n.Settings.infoDotBorderWidth*a,this.vc.requestInvalidate(),this.tooltipIsShown==!0&&stopAnimationTooltip(),this.tooltipIsShown=!1,tooltipMode="default",this.vc.currentlyHoveredInfodot=undefined,this.vc._setConstraintsByInfodotHover(undefined),this.vc.RaiseCursorChanged()},this.onmouseclick=function(n){return l(this,n,1)};var tt=!0,w=this,g=new f(t,i,u+"_dlod",o-b,c-b,2*b,2*b);g.removeWhenInvisible=!0,r(this,g,!1),g.firstLoad=!0,g.changeZoomLevel=function(f,l){var ut,v,y,k,ot,nt;if(l>=n.Settings.infodotShowContentThumbZoomLevel&&l<infodotShowContentZoomLevel){if(ut=getURL(),typeof ut.hash.params!="undefined"&&typeof ut.hash.params.b!="undefined"&&(tt=!1),f>=n.Settings.infodotShowContentThumbZoomLevel&&f<infodotShowContentZoomLevel)return null;if(w.tooltipEnabled=!0,v=null,w.contentItems.length>0&&(v=new s(t,i,u+"__contentItems",g.x,g.y,2*b,2*b),y=d(w.contentItems,o,c,b,t,i),y))for(k=0;k<y.length;k++)r(v,y[k],!1);return v?(w.hasContentItems=!0,{zoomLevel:l,content:v}):null}if(l>=infodotShowContentZoomLevel){if(f>=infodotShowContentZoomLevel)return null;if(w.tooltipEnabled=!1,w.tooltipIsShown==!0&&(stopAnimationTooltip(),w.tooltipIsShown=!1),v=null,w.contentItems.length>0&&(v=new s(t,i,u+"__contentItems",g.x,g.y,2*b,2*b),y=d(w.contentItems,o,c,b,t,i),y))for(k=0;k<y.length;k++)r(v,y[k],!1);if(v==null)return null;var ft=n.Settings.infodotTitleWidth*a*2,st=n.Settings.infodotTitleHeight*a*2,ht=140/225*a,ct=c-ht-st,lt="";p&&p.title&&p.date&&(lt=p.title+"\n("+p.date+")"),e(v,i,u+"__title",o-ft/2,ct,ct,st,lt,{fontName:n.Settings.contentItemHeaderFontName,fillStyle:n.Settings.contentItemHeaderFontColor,textBaseline:"middle",textAlign:"center",wrapText:!0,numberOfLines:2},ft);var at=c+ht+63/225*a,et=n.Settings.infodotBibliographyHeight*a*2,vt=ft/3,it=e(v,i,u+"__bibliography",o-vt/2,at-et,at-et/2,et,"Bibliography",{fontName:n.Settings.contentItemHeaderFontName,fillStyle:n.Settings.timelineBorderColor,textBaseline:"middle",textAlign:"center"},vt);if(it.reactsOnMouse=!0,it.onmouseclick=function(){return this.vc.element.css("cursor","default"),showBibliography({infodot:p,contentItems:w.contentItems},v,u+"__bibliography"),!0},it.onmouseenter=function(){this.settings.fillStyle=n.Settings.infoDotHoveredBorderColor,this.vc.requestInvalidate(),this.vc.element.css("cursor","pointer")},it.onmouseleave=function(){this.settings.fillStyle=n.Settings.infoDotBorderColor,this.vc.requestInvalidate(),this.vc.element.css("cursor","default")},ot=window.location.hash.match("b=([a-z0-9_]+)"),ot&&tt&&showBibliography({infodot:p,contentItems:w.contentItems},v,ot[1]),v)return w.hasContentItems=!0,{zoomLevel:l,content:v}}else{if((w.tooltipEnabled=!0,w.hasContentItems=!1,w.contentItems.length==0)||(nt=l,nt<=n.Settings.contentItemThumbnailMinLevel&&f<=n.Settings.contentItemThumbnailMinLevel&&f>0))return null;if(nt>=n.Settings.contentItemThumbnailMaxLevel){if(f>=n.Settings.contentItemThumbnailMaxLevel&&f<infodotShowContentZoomLevel)return null;nt=n.Settings.contentItemThumbnailMaxLevel}if(nt<n.Settings.contentItemThumbnailMinLevel)return{zoomLevel:nt,content:new s(t,i,u+"__empty",o,c,0,0)};var v=w.contentItems[0],yt=1<<nt,pt=n.Settings.contentItemThumbnailBaseUri+"x"+yt+"/"+v.guid+".png",rt=b*260/225;return{zoomLevel:nt,content:new h(t,i,u+"@"+nt,pt,o-rt/2,c-rt/2,rt,rt)}}};var nt=1/225,it=252*nt,rt=262*nt,ut=3*nt*a,ft=24*nt*a,et=-it/2*a+o,ot=-rt/2*a+c,st=it/2*a+o,ht=rt/2*a+c;this.render=function(t,i,r,u,f){var h;if(k.prototype.render.call(this,t,i,r,u,f),h=r.widthVirtualToScreen(ut),!(h<.5)){var c=this.width/2,l=this.x+c,a=this.y+c,v=u.x/2,e=r.widthVirtualToScreen(ft),o=r.pointVirtualToScreen(et,ot),s=r.pointVirtualToScreen(st,ht);t.lineWidth=h,t.strokeStyle=n.Settings.contentItemBoundingBoxFillColor,t.beginPath(),t.moveTo(o.x,o.y),t.lineTo(o.x-e,o.y-e),t.stroke(),t.beginPath(),t.moveTo(s.x,s.y),t.lineTo(s.x+e,s.y+e),t.stroke(),t.beginPath(),t.moveTo(o.x,s.y),t.lineTo(o.x-e,s.y+e),t.stroke(),t.beginPath(),t.moveTo(s.x,o.y),t.lineTo(s.x+e,o.y-e),t.stroke()}}}function ti(t,i){var r;if(t.type!=="infodot"||t.contentItems.length===0)return null;var f=t.width/2,e=f-n.Settings.infoDotHoveredBorderWidth*f,u=d(t.contentItems,t.x+t.width/2,t.y+t.height/2,e,t.vc,t.layerid);if(!u)return null;for(r=0;r<u.length;r++)if(u[r].id==i)return{x:u[r].x,y:u[r].y,width:u[r].width,height:u[r].height,parent:t};return null}function ii(n,t,i,u,f,e,o,s){var h=new k(n.vc,t,i,u,f,e,o,s);return r(n,h,!0)}function d(n,t,i,r,u,f){var p=n.length,et,ot,e,o;if(p<=0)return null;p--;var h=[],l=1/225,w=260*l,b=270*l,it=-w/2-38*l,st=-it,a=60*l,v=a,k=a*r,d=v*r,ht=-b/2-9*l-v/2,ct=-ht;h.push(new c(u,f,n[0].id,-w/2*r+t,-b/2*r+i,w*r,b*r,n[0]));var nt=Math.floor(p/3),tt=p%3,rt=nt+(tt>0?1:0),ut=nt+(tt>1?1:0),ft=nt+(tt>2?1:0),s=1,y=g(rt,v),lt=t+r*(it-a/2);for(e=0;e<rt;e++,s++)o=n[s],h.push(new c(u,f,o.id,lt,i+r*y[e],k,d,o));for(y=g(ft,a),et=i+r*(ct-v/2),e=0;e<ft;e++,s++)o=n[s],h.push(new c(u,f,o.id,t+r*y[e],et,k,d,o));for(y=g(ut,v),ot=t+r*(st-a/2),e=ut;--e>=0;s++)o=n[s],h.push(new c(u,f,o.id,ot,i+r*y[e],k,d,o));return h}function g(n,t){if(n==0)return null;var r=.05*t,i,u,f,e;return n%2==0?(i=-r/2-t,u=r/2,n==4)?(f=i-t-r,e=u+r+t,[f,i,u,e]):[i,u]:(i=-t/2,n>1)?(u=t/2+r,f=i-t-r,[f,i,u]):[i]}var w=$.Event("elementclick"),l;t.getVisibleForElement=nt,l=function(n,t,i){var r=n.vc.getViewport(),u=nt(n,i,r);return w.newvisible=u,w.element=n,n.vc.element.trigger(w),!0};var at=function(n,t,i,u,f,e,o,s){return r(n,new a(n.vc,t,i,u,f,e,o,s),!1)},ri=function(n,t,i,u,f,e,o,s){return r(n,new v(n.vc,t,i,u,f,e,o),s)},vt=function(n,t,i,u,f,e,o,s,c){if(e<=0||o<=0)throw"Image size must be positive";return r(n,new h(n.vc,t,i,s,u,f,e,o,c),!1)},ui=function(n,t,i,u,f,e,o,s,h){if(e<=0||o<=0)throw"Image size must be positive";return r(n,new st(n.vc,t,i,s,u,f,e,o,h),!1)},yt=function(n,t,i,u,f,e,o,s,h,c){if(e<=0||o<=0)throw"Image size must be positive";return r(n,new p(n.vc,n,t,i,h,u,f,e,o,s,c),!1)},pt=function(n,t,i,u,f,e,o,s,h){return r(n,new ct(n.vc,t,i,u,f,e,o,s,h),!1)},wt=function(n,t,i,u,f,e,o,s,h){return r(n,new ht(n.vc,t,i,u,f,e,o,s,h),!1)},bt=function(n,t,i,u,f,e,o,s,h){return r(n,new lt(n.vc,t,i,u,f,e,o,s,h),!1)};var tt=function(n,t,i,r,u){var f,s,o,h,e;if(!n.isVisible(i)){n.isRendered&&b(n);return}if(f=r.vectorVirtualToScreen(n.width,n.height),f.y<=renderThreshold||n.width!=0&&f.x<=renderThreshold){n.isRendered&&b(n);return}for(s=t[n.layerid],n.opacity!=null&&(u*=n.opacity),n.isRendered!=undefined&&n.isRendered||(n.isRendered=!0,n.onIsRenderedChanged&&n.onIsRenderedChanged()),n.render(s,i,r,f,u),o=n.children,h=o.length,e=0;e<h;e++)tt(o[e],t,i,r,u)},r=function(n,t,i){var r=n.width==Infinity||t.x>=n.x&&t.x+t.width<=n.x+n.width&&t.y>=n.y&&t.y+t.height<=n.y+n.height;if(!r&&Log&&Log.push("Child element does not belong to the parent element "+n.id+" "+t.ID),!i&&!r)throw"Child element does not belong to the parent element";return n.children.push(t),t.parent=n,t},o=function(n,t){for(var u=n.children.length,i,r=0;r<u;r++)if(i=n.children[r],i.id==t)return n.children.splice(r,1),it(i),i.onRemove&&i.onRemove(),i.parent=null,!0;return!1};t.getChild=dt,t.CanvasRootElement=rt,rt.prototype=i,f.prototype=i,s.prototype=i,a.prototype=i,ut.prototype=a,v.prototype=i,et.prototype=i,ot.prototype=i,h.prototype=i,st.prototype=f,u.prototype=i,y.prototype=u,ht.prototype=u,ct.prototype=u,lt.prototype=u,p.prototype=u,t.addTimeline=ni,c.prototype=f,k.prototype=v,t.getContentItem=ti,t.addInfodot=ii})(n.VCContent||(n.VCContent={}));var t=n.VCContent})(ChronoZoom||(ChronoZoom={}))