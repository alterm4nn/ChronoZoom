var ChronoZoom;(function(n){(function(t){function r(t){this.isForciblyStoped=!1,this.id=i++;var r=t.visible;this.velocity=.001,this.isActive=!0,this.type="PanZoom",this.startViewport=new n.Viewport.Viewport2d(t.aspectRatio,t.width,t.height,new n.Viewport.VisibleRegion2d(r.centerX,r.centerY,r.scale)),this.estimatedEndViewport,this.endCenterInSC,this.startCenterInSC=this.startViewport.pointVirtualToScreen(r.centerX,r.centerY),this.previousFrameCenterInSC=this.startCenterInSC,this.previousFrameViewport=this.startViewport,this.prevFrameTime=new Date,this.direction,this.pathLeng,this.setTargetViewport=function(t){var i,r,u,f;this.estimatedEndViewport=t,i=this.previousFrameViewport.visible,this.startViewport=new n.Viewport.Viewport2d(this.previousFrameViewport.aspectRatio,this.previousFrameViewport.width,this.previousFrameViewport.height,new n.Viewport.VisibleRegion2d(i.centerX,i.centerY,i.scale)),this.startCenterInSC=this.startViewport.pointVirtualToScreen(i.centerX,i.centerY),this.previousFrameCenterInSC={x:this.startCenterInSC.x,y:this.startCenterInSC.y},r=this.estimatedEndViewport.visible,this.endCenterInSC=this.startViewport.pointVirtualToScreen(r.centerX,r.centerY),this.direction={X:this.endCenterInSC.x-this.startCenterInSC.x,Y:this.endCenterInSC.y-this.startCenterInSC.y},u=this.direction.X,f=this.direction.Y,this.pathLeng=Math.sqrt(u*u+f*f),this.pathLeng<.1?(this.direction.X=this.direction.Y=0,r.scale==i.scale&&(this.isActive=!1)):(this.direction.X/=this.pathLeng,this.direction.Y/=this.pathLeng)},this.produceNextVisible=function(t){var p=this.startViewport.pointVirtualToScreen(t.visible.centerX,t.visible.centerY),w=t.visible.scale,s=this.startViewport.visible,h=new Date,l=h.getTime()-this.prevFrameTime.getTime(),f=this.velocity*l,r=this.endCenterInSC.x-this.previousFrameCenterInSC.x,u=this.endCenterInSC.y-this.previousFrameCenterInSC.y,c=Math.max(1,Math.sqrt(r*r+u*u)),e=this.previousFrameViewport.visible,i=new n.Viewport.VisibleRegion2d(e.centerX,e.centerY,e.scale),o;this.previousFrameCenterInSC.x+=c*f*this.direction.X,this.previousFrameCenterInSC.y+=c*f*this.direction.Y,i.scale+=(this.estimatedEndViewport.visible.scale-i.scale)*f,this.prevFrameTime=h,r=this.previousFrameCenterInSC.x-this.startCenterInSC.x,u=this.previousFrameCenterInSC.y-this.startCenterInSC.y;var a=Math.sqrt(r*r+u*u),v=this.estimatedEndViewport.visible.scale-s.scale,y=i.scale-s.scale;return a>=this.pathLeng||Math.abs(y)>Math.abs(v)?(this.isActive=!1,this.estimatedEndViewport.visible):(o=this.startViewport.pointScreenToVirtual(this.previousFrameCenterInSC.x,this.previousFrameCenterInSC.y),i.centerX=o.x,i.centerY=o.y,this.previousFrameViewport.visible=i,i)}}function u(t,r){function l(n){return(Math.exp(n)+Math.exp(-n))/2}function b(n){return(Math.exp(n)-Math.exp(-n))/2}function nt(n){return b(n)/l(n)}var o,a,w,g,p;this.isForciblyStoped=!1,this.id=i++,this.type="EllipticalZoom",this.isActive=!0,this.targetVisible=new n.Viewport.VisibleRegion2d(r.centerX,r.centerY,r.scale),this.startTime=(new Date).getTime(),this.imprecision=.0001,this.u=function(n){return this.startScale/Math.pow(this.ro,2)*l(this.r0)*nt(this.ro*n+this.r0)-this.startScale/Math.pow(this.ro,2)*b(this.r0)+this.u0},this.scale=function(n){return this.startScale*l(this.r0)/l(this.ro*n*this.S+this.r0)},this.x=function(n){return s.X+(c.X-s.X)/this.pathLen*this.u(n*this.S)},this.y=function(n){return s.Y+(c.Y-s.Y)/this.pathLen*this.u(n*this.S)},this.produceNextVisible=function(){var i=(new Date).getTime(),t;return t=this.duration>0?Math.min(1,(i-this.startTime)/this.duration):1,t=f(t),t==1&&(this.isActive=!1),new n.Viewport.VisibleRegion2d(this.x(t),this.y(t),this.scale(t))};var s={X:t.centerX,Y:t.centerY},u=t.scale,c={X:r.centerX,Y:r.centerY},e=r.scale,k=s.X-c.X,d=s.Y-c.Y;if(this.pathLen=Math.sqrt(k*k+d*d),o=.1*n.Settings.ellipticalZoomZoomoutFactor,this.ro=o,a=0,this.u0=a,w=this.pathLen,this.startPoint=s,this.startScale=u,this.endPoint=c,this.endScale=e,Math.abs(a-w)>this.imprecision){var h=a-w,v=(e*e-u*u+Math.pow(o,4)*h*h)/(2*u*o*o*-h),y=(e*e-u*u-Math.pow(o,4)*h*h)/(2*e*o*o*-h);this.r0=Math.log(-v+Math.sqrt(v*v+1)),this.r0==-Infinity&&(this.r0=-Math.log(2*v)),this.r1=Math.log(-y+Math.sqrt(y*y+1)),this.r1==-Infinity&&(this.r1=-Math.log(2*y)),this.S=(this.r1-this.r0)/o,this.duration=n.Settings.ellipticalZoomDuration/300*this.S}else g=Math.log(Math.abs(e-u))+10,g<0&&(this.isActive=!1),p=.5,(e!==0||u!==0)&&(p=Math.min(e,u)/Math.max(e,u)),p===1&&(this.isActive=!1),this.duration=n.Settings.ellipticalZoomDuration*p*.2,this.x=function(){return this.startPoint.X},this.y=function(){return this.startPoint.Y},this.scale=function(n){return this.startScale+(this.endScale-this.startScale)*n}}function f(n){return-2*n*n*n+3*n*n}var i=1;t.PanZoomAnimation=r,t.EllipticalZoom=u})(n.ViewportAnimation||(n.ViewportAnimation={}));var t=n.ViewportAnimation})(ChronoZoom||(ChronoZoom={}))