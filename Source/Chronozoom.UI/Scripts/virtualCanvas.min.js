var ChronoZoom;(function(n){(function(){$.widget("ui.virtualCanvas",{_layersContent:undefined,_layers:[],_self:null,_create:function(){var i,t;this._self=this,this._self.element.addClass("virtualCanvas"),i=this._self._getClientSize(),this.lastEvent=null,this.canvasWidth=null,this.canvasHeight=null,this._self.cursorPositionChangedEvent=new $.Event("cursorPositionChanged"),this._self.breadCrumbsChengedEvent=$.Event("breadCrumbsChanged"),this._self.innerZoomConstraintChengedEvent=$.Event("innerZoomConstraintChenged"),this._self.currentlyHoveredInfodot=undefined,this._self.breadCrumbs=[],this._self.recentBreadCrumb={vcElement:{title:"initObject"}},this._self.cursorPosition=0,t=this._self.element.children("div"),t.each(function(n){$(this).addClass("virtualCanvasLayerDiv").zIndex(n*3);var t=$("<canvas><\/canvas>").appendTo($(this)).addClass("virtualCanvasLayerCanvas").zIndex(n*3+1);this._self._layers.push($(this))}),this._layersContent=new n.VCContent.CanvasRootElement(self,undefined,"__root__",-Infinity,-Infinity,Infinity,Infinity),this.options.visible=new n.Viewport.VisibleRegion2d(0,0,1),this.updateViewport(),this._self.element.bind("mousemove."+this.widgetName,function(n){this._self.mouseMove(n)}),this._self.element.bind("mousedown."+this.widgetName,function(n){switch(n.which){case 1:this._self._mouseDown(n)}}),this._self.element.bind("mouseup."+this.widgetName,function(n){switch(n.which){case 1:this._self._mouseUp(n)}}),this._self.element.bind("mouseleave."+this.widgetName,function(n){this._self._mouseLeave(n)})},destroy:function(){this._destroy()},_mouseDown:function(n){var t=getXBrowserMouseOrigin(this.element,n);this.lastClickPosition={x:t.x,y:t.y},$("iframe").css("pointer-events","none"),$("#iframe_layer").css("display","block").css("z-index","99999")},_mouseUp:function(n){var t=getXBrowserMouseOrigin(this.element,n);this.lastClickPosition&&this.lastClickPosition.x==t.x&&this.lastClickPosition.y==t.y&&this._mouseClick(n),$("iframe").css("pointer-events","auto"),$("#iframe_layer").css("display","none")},_mouseLeave:function(n){if(this.currentlyHoveredContentItem!=null&&this.currentlyHoveredContentItem.onmouseleave!=null)this.currentlyHoveredContentItem.onmouseleave(n);if(this.currentlyHoveredInfodot!=null&&this.currentlyHoveredInfodot.onmouseleave!=null)this.currentlyHoveredInfodot.onmouseleave(n);if(this.currentlyHoveredTimeline!=null&&this.currentlyHoveredTimeline.onmouseunhover!=null)this.currentlyHoveredTimeline.onmouseunhover(null,n);stopAnimationTooltip(),this.lastEvent=null},_mouseClick:function(n){var u=this.getViewport(),t=getXBrowserMouseOrigin(this.element,n),i=u.pointScreenToVirtual(t.x,t.y),r=function(t,u){var o=t.isInside(u),f,e;if(!o)return!1;for(f=0;f<t.children.length;f++)if(e=t.children[f],r(e,i))return!0;return t.reactsOnMouse&&t.onmouseclick?t.onmouseclick(u,n):!1};r(this._layersContent,i)},getHoveredInfodot:function(){return this.currentlyHoveredInfodot},getCursorPosition:function(){return this.cursorPosition},_setConstraintsByInfodotHover:function(n){var t,i;n?(i=this.getViewport(),t=n.outerRad*infoDotZoomConstraint/i.width):t=undefined,this.RaiseInnerZoomConstraintChenged(t)},RaiseInnerZoomConstraintChenged:function(n){this.innerZoomConstraintChengedEvent.zoomValue=n,this.element.trigger(this.innerZoomConstraintChengedEvent)},RaiseCursorChanged:function(){this.cursorPositionChangedEvent.Time=this._self.cursorPosition,this.element.trigger(this.cursorPositionChangedEvent)},updateTooltipPosition:function(n){var i=this.viewport.pointVirtualToScreen(n.x,n.y),r=17,u,f,t=null;(tooltipMode=="infodot"?t=this.currentlyHoveredInfodot:tooltipMode=="timeline"&&(t=this.currentlyHoveredTimeline),t!=null)&&(u=parseInt(i.x)+t.panelWidth,f=parseInt(i.y)+t.panelHeight+r,u>this.canvasWidth&&(i.x=this.canvasWidth-t.panelWidth),f>this.canvasHeight&&(i.y=this.canvasHeight-t.panelHeight-r+1),$(".bubbleInfo").css({position:"absolute",top:i.y,left:i.x}))},mouseMove:function(n){var o=this.getViewport(),e=getXBrowserMouseOrigin(this.element,n),i=o.pointScreenToVirtual(e.x,e.y),t,f,r,u;if(this.currentlyHoveredInfodot||(this.cursorPosition=i.x,this.RaiseCursorChanged()),this.currentlyHoveredTimeline||(this.cursorPosition=i.x,this.RaiseCursorChanged()),t=[],f=function(i,r,u){var e,o,s;if(r){if(i.reactsOnMouse&&i.isMouseIn&&i.onmouseleave){i.onmouseleave(u,n);i.isMouseIn=!1}}else{if(e=i.isInside(u),r=!e,i.reactsOnMouse)if(e){if(i.isMouseIn){if(i.onmousemove)i.onmousemove(u,n);i.onmousehover&&t.push(i)}else if(i.isMouseIn=!0,i.onmouseenter)i.onmouseenter(u,n)}else if(i.isMouseIn){if(i.isMouseIn=!1,i.onmouseleave)i.onmouseleave(u,n)}else if(i.onmousemove)i.onmousemove(u,n);i.isMouseIn=e}for(o=0;o<i.children.length;o++)s=i.children[o],(!r||s.isMouseIn)&&f(s,r,u)},f(this._layersContent,!1,i),t.length==0&&this.hovered&&this.hovered.onmouseunhover){this.hovered.onmouseunhover(i,n);this.hovered=null}for(r=t.length;--r>=0;)if(t[r].onmousehover){t[r].onmousehover(i,n);if(this.hovered&&this.hovered!=t[r]&&this.hovered.onmouseunhover)this.hovered.onmouseunhover(i,n);this.hovered=t[r];break}(this.currentlyHoveredInfodot!=null&&this.currentlyHoveredInfodot.tooltipEnabled==!0||this.currentlyHoveredTimeline!=null&&this.currentlyHoveredTimeline.tooltipEnabled==!0&&tooltipMode!="infodot")&&(u=null,tooltipMode=="infodot"?u=this.currentlyHoveredInfodot:tooltipMode=="timeline"&&(u=this.currentlyHoveredTimeline),u!=null&&u.tooltipIsShown==!1&&(u.tooltipIsShown=!0,animationTooltipRunning=$(".bubbleInfo").fadeIn()),this.updateTooltipPosition(i)),this.lastEvent=n},getLastEvent:function(){return this.lastEvent},getLayerContent:function(){return this._layersContent},findElement:function(n){var t=function(n,i){var f,r,u,e;if(n.id===i)return n;if(!n.children)return null;for(f=n.children.length,r=0;r<f;r++)if(u=n.children[r],u.id===i)return u;for(r=0;r<f;r++)if(u=n.children[r],e=t(u,i),e)return e;return null};return t(this._layersContent,n)},_destroy:function(){return this.element.removeClass("virtualCanvas"),this.element.children(".virtualCanvasLayerDiv").each(function(){$(this).removeClass("virtualCanvasLayerDiv"),$(this).remove(".virtualCanvasLayerCanvas")}),this.element.unbind("."+this.widgetName),this._layers=undefined,this._layersContent=undefined,this},_visibleToViewBox:function(n){var t=this.getViewport(),i=t.widthScreenToVirtual(t.width),r=t.heightScreenToVirtual(t.height),u=n.centerX-i/2,f=n.centerY-r/2;return{Left:u,Right:u+i,Top:f,Bottom:f+r}},setVisible:function(n,t){delete this.viewport,this.options.visible=n,this.isInAnimation=t&&t.isActive;var i=this._visibleToViewBox(n),r=this.getViewport();this._renderCanvas(this._layersContent,i,r)},updateViewport:function(){for(var n=this._getClientSize(),u=this._layers.length,r,i,t=0;t<u;t++)r=this._layers[t],r.width(n.width).height(n.height),i=r.children(".virtualCanvasLayerCanvas").first()[0],i&&(i.width=n.width,i.height=n.height);this.canvasWidth=$("#vc").width(),this.canvasHeight=$("#vc").height(),this.setVisible(this.options.visible)},_getClientSize:function(){return{width:this.element[0].clientWidth,height:this.element[0].clientHeight}},getViewport:function(){if(!this.viewport){var n=this._getClientSize(),t=this.options;this.viewport=new Viewport2d(t.aspectRatio,n.width,n.height,t.visible)}return this.viewport},_renderCanvas:function(n,t,i){var f=this._layers.length,u,r,s;if(f!=0){for(u={},r=0;r<f;r++){var e=this._layers[r],h=e.children(".virtualCanvasLayerCanvas").first()[0],o=h.getContext("2d");o.clearRect(0,0,i.width,i.height),s=e[0].id,u[s]=o}n.render(u,t,i)}},invalidate:function(){var n=this._visibleToViewBox(this.options.visible),t=this.getViewport();this._renderCanvas(this._layersContent,n,t)},breadCrumbsChanged:function(){this.breadCrumbsChengedEvent.breadCrumbs=this.breadCrumbs,this.element.trigger(this.breadCrumbsChengedEvent)},requestInvalidate:function(){if(!this.isInAnimation){this.isInAnimation=!0;var n=this;setTimeout(function(){n.isInAnimation=!1,n.invalidate()},1e3/targetFps)}},options:{aspectRatio:1,visible:{centerX:0,centerY:0,scale:1}}})})(n.VirtualCanvas||(n.VirtualCanvas={}));var t=n.VirtualCanvas})(ChronoZoom||(ChronoZoom={}))