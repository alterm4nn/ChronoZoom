var __extends=this.__extends||function(n,t){function r(){this.constructor=n}for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i]);r.prototype=t.prototype;n.prototype=new r},CZ;(function(n){(function(t){var i=function(){function t(n,t){if(n==undefined||n==null)throw"target element of a tour stop is null or undefined";if(typeof n.type=="undefined")throw"type of the tour stop target element is undefined";this.targetElement=n;n.type==="Unknown"?(this.type=n.type,this.title=t):n.type==="contentItem"?(this.type="Content Item",this.title=t?t:n.contentItem.title):(this.type=n.type==="timeline"?"Timeline":"Event",this.title=t?t:n.title)}return Object.defineProperty(t.prototype,"Target",{get:function(){return this.targetElement},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Title",{get:function(){return this.title},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Description",{get:function(){return this.description},set:function(n){this.description=n},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"LapseTime",{get:function(){return this.lapseTime},set:function(n){this.lapseTime=n},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"Type",{get:function(){return this.type},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"NavigationUrl",{get:function(){return n.UrlNav.vcelementToNavString(this.targetElement)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ThumbnailUrl",{get:function(){return this.thumbUrl||(this.thumbUrl=this.GetThumbnail(this.targetElement)),this.thumbUrl},enumerable:!0,configurable:!0}),t.prototype.GetThumbnail=function(t){var f="/images/Temp-Thumbnail2.png",e,o,r,i,u;try{if(!t)return f;if(t.type==="contentItem")return n.Settings.contentItemThumbnailBaseUri+"x64/"+t.id+".png";if(t.type==="infodot"){if(t.contentItems&&t.contentItems.length>0)return i=t.contentItems[0],e=n.Settings.contentItemThumbnailBaseUri+"x64/"+i.id+".png",e}else if(t.type==="timeline")for(o=t.children.length,r=0;r<o;r++)if(i=t.children[r],(i.type==="infodot"||i.type==="timeline")&&(u=this.GetThumbnail(i),u&&u!==f))return u}catch(s){console&&console.error&&console.error("Failed to get a thumbnail url: "+s)}return f},t}(),r,u;t.TourStop=i;r=function(){function n(n,t,i,r,u,f,e){this.id=n;this.title=t;this.description=i;this.audio=r;this.sequence=f;this.stops=e;this.category=u}return Object.defineProperty(n.prototype,"Id",{get:function(){return this.id},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"Title",{get:function(){return this.title},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"Category",{get:function(){return this.category},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"Sequence",{get:function(){return this.sequence},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"Description",{get:function(){return this.description},set:function(n){this.description=n},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"Audio",{get:function(){return this.audio},set:function(n){this.audio=n},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"Stops",{get:function(){return this.stops},enumerable:!0,configurable:!0}),n}();t.Tour=r;u=function(t){function r(i,u){var o,f,e,s,h,c;if(t.call(this,i,u),this.saveButton=i.find(u.saveButton),this.deleteButton=i.find(u.deleteButton),this.addStopButton=i.find(u.addStopButton),this.titleInput=i.find(u.titleInput),this.tourTitleInput=this.container.find(".cz-form-tour-title"),this.tourDescriptionInput=this.container.find(".cz-form-tour-description"),this.tourAudioPicker=this.container.find(".cz-medialist-item-icon"),this.tourAudioInput=this.container.find("#cz-form-tour-audio"),this.tourAudioControls=this.container.find(".audiojs"),this.clean(),this.saveButton.off(),this.deleteButton.off(),this.tour=u.context,o=[],f=this,this.tour)for(this.tourTitleInput.val(this.tour.title),this.tourDescriptionInput.val(this.tour.description),this.tourAudioInput.val(this.tour.audio),e=0,s=this.tour.bookmarks.length;e<s;e++)h=this.tour.bookmarks[e],c=r.bookmarkToTourstop(h),o.push(c);else this.tourTitleInput.val(""),this.tourDescriptionInput.val("");this.tourStopsListBox=new n.UI.TourStopListBox(i.find(u.tourStopsListBox),u.tourStopsTemplate,o);this.tourStopsListBox.itemMove(function(n,t,i){return f.onStopsReordered.apply(f,[n,t,i])});this.tourStopsListBox.itemRemove(function(n,t){return f.onStopRemoved.apply(f,[n,t])});this.initialize()}return __extends(r,t),r.bookmarkToTourstop=function(t){var u=n.Tours.bookmarkUrlToElement(t.url),r;return u==null&&(u={type:"Unknown"}),r=new i(u,!t.caption||$.trim(t.caption)===""?undefined:t.caption),r.Description=t.text,r.LapseTime=t.lapseTime,r},r.tourstopToBookmark=function(t,i){var u=n.UrlNav.vcelementToNavString(t.Target),f=t.Title,r=new n.Tours.TourBookmark(u,f,t.LapseTime,t.Description);return r.number=i+1,r},r.prototype.deleteTourAsync=function(){return n.Service.deleteTour(this.tour.id)},r.prototype.putTourAsync=function(t){var i=$.Deferred(),a=this,u=this.getStops(),e=this.tourTitleInput.val(),o=this.tourDescriptionInput.val(),s=this.tourAudioInput.val(),f="tours",h=u.length,c=undefined,l;return this.tour&&(f=this.tour.category,c=this.tour.id),l=n.Service.putTour2(new n.UI.Tour(c,e,o,s,f,h,u)),l.done(function(c){for(var v,y,p,a=[],l=0;l<h;l++)v=u[l],y=r.tourstopToBookmark(v,l),a.push(y);p=new n.Tours.Tour(c.TourId,e,a,n.Tours.bookmarkTransition,n.Common.vc,f,s,t,o);i.resolve(p)}).fail(function(n){i.reject(n)}),i.promise()},r.prototype.initializeAsEdit=function(){this.deleteButton.show();this.titleTextblock.text("Edit Tour");this.saveButton.text("Update Tour")},r.prototype.initialize=function(){var t=this,i;this.saveButton.prop("disabled",!1);this.tour==null?(this.deleteButton.hide(),this.titleTextblock.text("Create Tour"),this.saveButton.text("Create Tour")):this.initializeAsEdit();i=this;WL.init({client_id:n.Settings.WLAPIClientID,redirect_uri:n.Settings.WLAPIRedirectUrl});this.tourAudioPicker.click(function(){WL.login({scope:["wl.skydrive","wl.signin"]}).then(function(){WL.fileDialog({mode:"open",select:"single"}).then(function(n){var i=n.data.files[0];i.type==="audio"&&i.name.toLowerCase().match(".mp3$")?(t.tourAudioInput.val(i.source),t.renderAudioControls()):alert("Sorry, you need to pick an MP3 file.")})})});this.renderAudioControls();this.tourAudioInput.on("change input",function(){t.renderAudioControls()});this.addStopButton.click(function(){n.Authoring.isActive=!0;n.Authoring.mode="editTour-selectTarget";n.Authoring.callback=function(n){return i.onTargetElementSelected(n)};i.hide();setTimeout(function(){n.Authoring.mode=="editTour-selectTarget"&&n.Authoring.showMessageWindow("Click an element to select it as a tour stop.","New tour stop",function(){if(n.Authoring.mode=="editTour-selectTarget")i.onTargetElementSelected(null)})},500)});this.saveButton.click(function(){var r="",u,i,f;if(t.tourTitleInput.val()||(r+="Please enter a title.\n"),t.tourAudioInput.val($.trim(t.tourAudioInput.val())),t.tourAudioInput.val()==""||n.Data.validURL(t.tourAudioInput.val())||(r+="Please provide a valid audio URL.\n"),t.tourStopsListBox.items.length==0&&(r+="Please add a tour stop to the tour.\n"),r){alert(r);return}if(u=t,t.saveButton.prop("disabled",!0),t.tour==null)t.putTourAsync(n.Tours.tours.length).done(function(i){u.tour=i;n.Tours.tours.push(i);t.hide()}).fail(function(n){console&&console.error&&console.error("Failed to create a tour: "+n.status+" "+n.statusText);alert("Failed to create a tour")}).done(function(){t.saveButton.prop("disabled",!1)});else for(i=0,f=n.Tours.tours.length;i<f;i++)if(n.Tours.tours[i]===t.tour){t.putTourAsync(i).done(function(r){t.tour=n.Tours.tours[i]=r;t.hide()}).fail(function(n){console&&console.error&&console.error("Failed to update a tour: "+n.status+" "+n.statusText);alert("Failed to update a tour")}).always(function(){t.saveButton.prop("disabled",!1)});break}});this.deleteButton.click(function(){t.tour!=null&&t.deleteTourAsync().done(function(){for(var i=0,r=n.Tours.tours.length;i<r;i++)if(n.Tours.tours[i]===t.tour){t.tour=null;n.Tours.tours.splice(i,1);t.close();break}}).fail(function(n){console&&console.error&&console.error("Failed to delete a tour: "+n.status+" "+n.statusText);alert("Failed to delete a tour")})})},r.prototype.getStops=function(){for(var n=this.tourStopsListBox.items.length,t=new Array(n);--n>=0;)t[n]=this.tourStopsListBox.items[n].data;return t},r.prototype.show=function(){t.prototype.show.call(this,{effect:"slide",direction:"left",duration:500});this.activationSource.addClass("active")},r.prototype.hide=function(n){typeof n=="undefined"&&(n=!1);t.prototype.close.call(this,n?undefined:{effect:"slide",direction:"left",duration:500});this.activationSource.removeClass("active")},r.prototype.close=function(){t.prototype.close.call(this,{effect:"slide",direction:"left",duration:500,complete:function(){}});n.Authoring.isActive=!1;this.clean()},r.prototype.clean=function(){this.activationSource.removeClass("active");this.container.find(".cz-form-errormsg").hide();this.container.find(".cz-listbox").empty();this.tourTitleInput.val("");this.tourDescriptionInput.val("");this.tourAudioInput.val("")},r.prototype.renderAudioControls=function(){this.tourAudioControls.find("audio").stop();this.tourAudioControls.find("audio").html('<source src="'+this.tourAudioInput.val()+'" />');n.Data.validURL(this.tourAudioInput.val())?this.tourAudioControls.show():this.tourAudioControls.hide()},r.prototype.onStopsReordered=function(){this.updateSequence()},r.prototype.onStopRemoved=function(){this.updateSequence()},r.prototype.updateSequence=function(){for(var u,i=this.getStops(),f=i.length,r=0,t=0;t<f;t++)u=i[t],u.LapseTime=r,r+=n.Settings.tourDefaultTransitionTime},r.prototype.onTargetElementSelected=function(t){if(n.Authoring.mode="editTour",n.Authoring.hideMessageWindow(),n.Authoring.isActive=!1,n.Authoring.callback=null,t){var u=this.tourStopsListBox.items.length,r=new i(t);r.LapseTime=u==0?0:this.tourStopsListBox.items[this.tourStopsListBox.items.length-1].data.LapseTime+n.Settings.tourDefaultTransitionTime;this.tourStopsListBox.add(r)}this.show()},r}(n.UI.FormBase);t.FormEditTour=u})(n.UI||(n.UI={}));var t=n.UI})(CZ||(CZ={}));
//# sourceMappingURL=auth-edit-tour-form.min.js.map
