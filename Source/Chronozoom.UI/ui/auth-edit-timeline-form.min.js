var __extends=this.__extends||function(n,t){function r(){this.constructor=n}for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i]);r.prototype=t.prototype;n.prototype=new r},CZ;(function(n){(function(t){var i=function(t){function i(i,r){var u=this;t.call(this,i,r);this.saveButton=i.find(r.saveButton);this.deleteButton=i.find(r.deleteButton);this.startDate=new n.UI.DatePicker(i.find(r.startDate));this.endDate=new n.UI.DatePicker(i.find(r.endDate));this.mediaListContainer=i.find(r.mediaListContainer);this.backgroundUrl=i.find(r.backgroundUrl);this.titleInput=i.find(r.titleInput);this.errorMessage=i.find(r.errorMessage);this.timeline=r.context;this.saveButton.off();this.deleteButton.off();this.titleInput.focus(function(){u.titleInput.hideError()});this.initialize()}return __extends(i,t),i.prototype.initialize=function(){var t=this;this.mediaInput={};this.mediaList=new n.UI.MediaList(this.mediaListContainer,n.Media.mediaPickers,this.mediaInput,this);this.mediaList.container.find("[title='skydrive']").hide();this.saveButton.prop("disabled",!1);n.Authoring.mode==="createTimeline"?(this.deleteButton.hide(),this.titleTextblock.text("Create Timeline"),this.saveButton.text("Create Timeline")):n.Authoring.mode==="editTimeline"?(this.deleteButton.show(),this.titleTextblock.text("Edit Timeline"),this.saveButton.text("Update Timeline")):n.Authoring.mode==="createRootTimeline"?(this.deleteButton.hide(),this.closeButton.hide(),this.titleTextblock.text("Create Root Timeline"),this.saveButton.text("Create Timeline")):(console.log("Unexpected authoring mode in timeline form."),this.close());this.isCancel=!0;this.endDate.addEditMode_Infinite();this.titleInput.val(this.timeline.title);this.startDate.setDate(this.timeline.x,!0);this.backgroundUrl.val(this.timeline.backgroundUrl||"");this.timeline.endDate===9999?this.endDate.setDate(this.timeline.endDate,!0):this.endDate.setDate(this.timeline.x+this.timeline.width,!0);$(t.startDate.circaSelector).find("input").prop("checked",this.timeline.FromIsCirca);$(t.endDate.circaSelector).find("input").prop("checked",this.timeline.ToIsCirca);this.saveButton.click(function(){function f(){t.errorMessage.empty();var u=t,f=i?i.width/i.height:null,e=f!==t.timeline.aspectRatio;t.timeline.FromIsCirca=$(t.startDate.circaSelector).find("input").is(":checked");t.timeline.ToIsCirca=$(t.endDate.circaSelector).find("input").is(":checked");t.saveButton.prop("disabled",!0);n.Authoring.updateTimeline(t.timeline,{title:t.titleInput.val(),start:t.startDate.getDate(),end:t.endDate.getDate(),backgroundUrl:r,aspectRatio:f}).then(function(){u.isCancel=!1;u.close();e&&(n.VCContent.clear(n.Common.vc.virtualCanvas("getLayerContent")),n.Common.reloadData().done(function(){u.timeline=n.Common.vc.virtualCanvas("findElement",u.timeline.id);u.timeline.animation=null;u.timeline.onmouseclick()}));u.timeline.onmouseclick()},function(n){n!==undefined&&n!==null?u.errorMessage.text(n).show().delay(7e3).fadeOut():u.errorMessage.text("Sorry, internal server error :(").show().delay(7e3).fadeOut();console.log(n)}).always(function(){t.saveButton.prop("disabled",!1)})}function e(){var n=t;n.errorMessage.empty();n.errorMessage.text("Please, set a correct URL for background image.").show().delay(7e3).fadeOut();n.backgroundUrl.val("")}t.errorMessage.empty();var u=!1,i,r=t.backgroundUrl.val().trim();if(u=n.Authoring.validateTimelineData(t.startDate.getDate(),t.endDate.getDate(),t.titleInput.val()),n.Authoring.isNotEmpty(t.titleInput.val())||t.titleInput.showError("Title cannot be empty"),n.Authoring.isIntervalPositive(t.startDate.getDate(),t.endDate.getDate())||t.errorMessage.text("Time interval cannot be less than one day"),u)r!==""?(i=new Image,i.addEventListener("load",f,!1),i.addEventListener("error",e,!1),i.src=r):f();else return});this.deleteButton.click(function(){if(confirm("Are you sure want to delete timeline and all of its nested timelines and exhibits? Delete can't be undone!"))n.Authoring.removeTimeline(t.timeline),t.close()})},i.prototype.updateMediaInfo=function(){this.backgroundUrl.val(this.mediaInput.uri||"")},i.prototype.show=function(){n.Menus.isDisabled=!0;n.Menus.Refresh();t.prototype.show.call(this,{effect:"slide",direction:"left",duration:500});this.activationSource.addClass("active")},i.prototype.close=function(){var i=this;this.errorMessage.empty();n.Menus.isDisabled=!1;n.Menus.Refresh();t.prototype.close.call(this,{effect:"slide",direction:"left",duration:500,complete:function(){i.endDate.remove();i.startDate.remove();i.titleInput.hideError();i.mediaList.remove()}});this.isCancel&&n.Authoring.mode==="createTimeline"&&(n.VCContent.removeChild(this.timeline.parent,this.timeline.id),n.Common.vc.virtualCanvas("requestInvalidate"));n.Authoring.isActive=!1;this.activationSource.removeClass("active");n.Common.vc.virtualCanvas("showNonRootVirtualSpace")},i}(n.UI.FormUpdateEntity);t.FormEditTimeline=i})(n.UI||(n.UI={}));var t=n.UI})(CZ||(CZ={}));